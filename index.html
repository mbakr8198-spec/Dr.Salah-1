<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>دكتور صلاح السنوسي - استشاري جراحة العظام والعمود الفقري</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        :root {
            --primary-color: #1a5f7a;
            --secondary-color: #159895;
            --accent-color: #57c5b6;
            --light-color: #f8f9fa;
            --dark-color: #2c3e50;
            --danger-color: #e74c3c;
            --success-color: #2ecc71;
            --warning-color: #f39c12;
            --info-color: #3498db;
            --border-radius: 8px;
            --box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        }
        
        body {
            background-color: #f5f7fa;
            color: #333;
            line-height: 1.6;
        }
        
        .container {
            width: 90%;
            max-width: 1400px;
            margin: 0 auto;
            padding: 0 15px;
        }
        
        header {
            background-color: white;
            box-shadow: var(--box-shadow);
            position: sticky;
            top: 0;
            z-index: 1000;
        }
        
        .header-container {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px 0;
        }
        
        .logo {
            display: flex;
            align-items: center;
        }
        
        .logo i {
            font-size: 2.5rem;
            color: var(--primary-color);
            margin-left: 10px;
        }
        
        .logo h1 {
            color: var(--primary-color);
            font-size: 1.8rem;
        }
        
        .logo span {
            color: var(--secondary-color);
            font-weight: 300;
            display: block;
            font-size: 1rem;
        }
        
        nav ul {
            display: flex;
            list-style: none;
        }
        
        nav ul li {
            margin-right: 20px;
        }
        
        nav ul li a {
            text-decoration: none;
            color: var(--dark-color);
            font-weight: 600;
            padding: 8px 15px;
            border-radius: var(--border-radius);
            transition: all 0.3s ease;
        }
        
        nav ul li a:hover, nav ul li a.active {
            background-color: var(--primary-color);
            color: white;
        }
        
        .main-content {
            padding: 30px 0;
            min-height: calc(100vh - 160px);
        }
        
        .page-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
            padding-bottom: 15px;
            border-bottom: 2px solid #eee;
        }
        
        .page-header h2 {
            color: var(--primary-color);
            font-size: 1.8rem;
        }
        
        .btn {
            padding: 10px 20px;
            background-color: var(--secondary-color);
            color: white;
            border: none;
            border-radius: var(--border-radius);
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s ease;
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }
        
        .btn:hover {
            background-color: var(--primary-color);
            transform: translateY(-2px);
        }
        
        .btn-primary {
            background-color: var(--primary-color);
        }
        
        .btn-primary:hover {
            background-color: #144d63;
        }
        
        .btn-warning {
            background-color: var(--warning-color);
        }
        
        .btn-warning:hover {
            background-color: #d68910;
        }
        
        .btn-danger {
            background-color: var(--danger-color);
        }
        
        .btn-danger:hover {
            background-color: #c0392b;
        }
        
        .btn-info {
            background-color: var(--info-color);
        }
        
        .btn-info:hover {
            background-color: #2980b9;
        }
        
        .cards-container {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(320px, 1fr));
            gap: 25px;
            margin-top: 30px;
        }
        
        .card {
            background-color: white;
            border-radius: var(--border-radius);
            box-shadow: var(--box-shadow);
            overflow: hidden;
            transition: transform 0.3s ease;
        }
        
        .card:hover {
            transform: translateY(-5px);
        }
        
        .card-header {
            background-color: var(--primary-color);
            color: white;
            padding: 15px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .card-header h3 {
            font-size: 1.3rem;
        }
        
        .card-body {
            padding: 20px;
        }
        
        .patient-info p, .surgery-info p {
            margin-bottom: 12px;
            display: flex;
            justify-content: space-between;
        }
        
        .patient-info span:first-child, .surgery-info span:first-child {
            font-weight: 600;
            color: var(--dark-color);
        }
        
        .patient-info span:last-child, .surgery-info span:last-child {
            color: #555;
        }
        
        .form-container {
            background-color: white;
            border-radius: var(--border-radius);
            box-shadow: var(--box-shadow);
            padding: 30px;
            max-width: 1000px;
            margin: 0 auto;
        }
        
        .form-group {
            margin-bottom: 20px;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: var(--dark-color);
        }
        
        .form-control {
            width: 100%;
            padding: 12px 15px;
            border: 1px solid #ddd;
            border-radius: var(--border-radius);
            font-size: 1rem;
            transition: border 0.3s ease;
        }
        
        .form-control:focus {
            outline: none;
            border-color: var(--accent-color);
        }
        
        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
        }
        
        .search-container {
            margin-bottom: 30px;
        }
        
        .search-box {
            display: flex;
            box-shadow: var(--box-shadow);
            border-radius: var(--border-radius);
            overflow: hidden;
        }
        
        .search-box input {
            flex: 1;
            padding: 15px 20px;
            border: none;
            font-size: 1rem;
        }
        
        .search-box button {
            background-color: var(--primary-color);
            color: white;
            border: none;
            padding: 0 25px;
            cursor: pointer;
            font-size: 1.1rem;
        }
        
        .table-container {
            background-color: white;
            border-radius: var(--border-radius);
            box-shadow: var(--box-shadow);
            overflow: hidden;
            margin-top: 30px;
        }
        
        table {
            width: 100%;
            border-collapse: collapse;
        }
        
        thead {
            background-color: var(--primary-color);
            color: white;
        }
        
        th, td {
            padding: 15px 20px;
            text-align: right;
            border-bottom: 1px solid #eee;
        }
        
        tbody tr:hover {
            background-color: #f8f9fa;
        }
        
        .action-buttons {
            display: flex;
            gap: 10px;
        }
        
        .action-btn {
            padding: 5px 10px;
            border-radius: 4px;
            cursor: pointer;
            border: none;
            color: white;
            font-size: 0.9rem;
        }
        
        .view-btn {
            background-color: var(--secondary-color);
        }
        
        .edit-btn {
            background-color: var(--accent-color);
        }
        
        .delete-btn {
            background-color: var(--danger-color);
        }
        
        .files-container {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
            gap: 20px;
        }
        
        .file-card {
            background-color: white;
            border-radius: var(--border-radius);
            box-shadow: var(--box-shadow);
            padding: 20px;
            text-align: center;
            transition: all 0.3s ease;
        }
        
        .file-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 6px 15px rgba(0, 0, 0, 0.15);
        }
        
        .file-icon {
            font-size: 3rem;
            color: var(--primary-color);
            margin-bottom: 15px;
        }
        
        .page {
            display: none;
        }
        
        .page.active {
            display: block;
            animation: fadeIn 0.5s ease;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        
        footer {
            background-color: var(--dark-color);
            color: white;
            padding: 30px 0;
            margin-top: 50px;
        }
        
        .footer-content {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .footer-logo h3 {
            color: white;
            font-size: 1.5rem;
            margin-bottom: 5px;
        }
        
        .footer-logo span {
            color: #bbb;
            font-size: 0.9rem;
        }
        
        .contact-info p {
            margin-bottom: 8px;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        @media (max-width: 992px) {
            .form-row {
                grid-template-columns: 1fr;
            }
            
            nav ul {
                display: none;
            }
        }
        
        @media (max-width: 768px) {
            .cards-container {
                grid-template-columns: 1fr;
            }
            
            .header-container {
                flex-direction: column;
                text-align: center;
            }
            
            .logo {
                margin-bottom: 15px;
            }
            
            .footer-content {
                flex-direction: column;
                text-align: center;
                gap: 20px;
            }
            
            th, td {
                padding: 10px 5px;
                font-size: 0.9rem;
            }
        }
        
        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 15px 25px;
            border-radius: var(--border-radius);
            color: white;
            font-weight: 600;
            z-index: 1001;
            box-shadow: var(--box-shadow);
            animation: slideIn 0.3s ease;
        }
        
        @keyframes slideIn {
            from { transform: translateX(100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }
        
        .success-notification {
            background-color: var(--success-color);
        }
        
        .error-notification {
            background-color: var(--danger-color);
        }
        
        .info-notification {
            background-color: var(--info-color);
        }
        
        .warning-notification {
            background-color: var(--warning-color);
        }
        
        .main-files-container {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 30px;
            margin-top: 30px;
        }
        
        .main-file-card {
            background-color: white;
            border-radius: var(--border-radius);
            box-shadow: var(--box-shadow);
            padding: 25px;
            text-align: center;
            transition: all 0.3s ease;
        }
        
        .main-file-card:hover {
            transform: translateY(-8px);
            box-shadow: 0 10px 20px rgba(0, 0, 0, 0.15);
        }
        
        .main-file-icon {
            font-size: 4rem;
            color: var(--primary-color);
            margin-bottom: 20px;
        }
        
        .file-count {
            display: inline-block;
            background-color: var(--accent-color);
            color: white;
            padding: 5px 15px;
            border-radius: 20px;
            font-size: 0.9rem;
            margin-top: 10px;
        }
        
        .profile-image-container {
            text-align: center;
            margin-bottom: 30px;
        }
        
        .profile-image {
            width: 250px;
            height: 250px;
            border-radius: 50%;
            object-fit: cover;
            border: 5px solid var(--accent-color);
            box-shadow: var(--box-shadow);
        }
        
        .patient-image-container {
            width: 100px;
            height: 100px;
            border-radius: 50%;
            overflow: hidden;
            margin: 0 auto 15px;
            border: 3px solid var(--accent-color);
        }
        
        .patient-image {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        
        .media-gallery-container {
            margin-top: 25px;
        }
        
        .media-gallery {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
            gap: 15px;
            margin-top: 15px;
            max-height: 400px;
            overflow-y: auto;
            padding: 10px;
            background-color: #f8f9fa;
            border-radius: var(--border-radius);
        }
        
        .media-item {
            position: relative;
            border-radius: var(--border-radius);
            overflow: hidden;
            height: 150px;
            background-color: #e9ecef;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .media-item img, .media-item video {
            width: 100%;
            height: 100%;
            object-fit: cover;
            cursor: pointer;
        }
        
        .media-item .file-icon {
            font-size: 3rem;
            color: #adb5bd;
        }
        
        .media-remove {
            position: absolute;
            top: 5px;
            left: 5px;
            background-color: rgba(231, 76, 60, 0.8);
            color: white;
            border: none;
            border-radius: 50%;
            width: 25px;
            height: 25px;
            cursor: pointer;
            font-size: 0.8rem;
            z-index: 10;
        }
        
        .media-type {
            position: absolute;
            bottom: 5px;
            right: 5px;
            background-color: rgba(0, 0, 0, 0.7);
            color: white;
            padding: 2px 8px;
            border-radius: 10px;
            font-size: 0.7rem;
        }
        
        .doctor-profile {
            display: grid;
            grid-template-columns: 1fr 2fr;
            gap: 40px;
            align-items: center;
            margin-bottom: 40px;
        }
        
        .doctor-info h2 {
            color: var(--primary-color);
            margin-bottom: 15px;
        }
        
        .doctor-info p {
            margin-bottom: 15px;
            font-size: 1.1rem;
            line-height: 1.8;
        }
        
        .doctor-specialties {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-top: 20px;
        }
        
        .specialty {
            background-color: #e8f4f8;
            color: var(--primary-color);
            padding: 8px 15px;
            border-radius: 20px;
            font-size: 0.9rem;
            font-weight: 600;
        }
        
        .image-upload-container {
            text-align: center;
            margin-bottom: 20px;
        }
        
        .upload-label {
            display: inline-block;
            padding: 12px 25px;
            background-color: var(--accent-color);
            color: white;
            border-radius: var(--border-radius);
            cursor: pointer;
            transition: all 0.3s ease;
            margin-bottom: 10px;
        }
        
        .upload-label:hover {
            background-color: var(--secondary-color);
        }
        
        .upload-input {
            display: none;
        }
        
        .upload-preview {
            width: 150px;
            height: 150px;
            border-radius: 50%;
            object-fit: cover;
            margin-top: 15px;
            border: 3px solid #ddd;
        }
        
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
            z-index: 1002;
            display: flex;
            justify-content: center;
            align-items: center;
        }
        
        .modal-content {
            background-color: white;
            width: 95%;
            max-width: 1200px;
            border-radius: var(--border-radius);
            padding: 30px;
            max-height: 90vh;
            overflow-y: auto;
        }
        
        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 25px;
        }
        
        .modal-header h3 {
            color: var(--primary-color);
        }
        
        .modal-close {
            background: none;
            border: none;
            font-size: 1.5rem;
            color: #777;
            cursor: pointer;
        }
        
        .full-media-gallery {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 20px;
            margin-top: 20px;
            max-height: 500px;
            overflow-y: auto;
            padding: 15px;
            background-color: #f8f9fa;
            border-radius: var(--border-radius);
        }
        
        .full-media-item {
            position: relative;
            border-radius: var(--border-radius);
            overflow: hidden;
            height: 200px;
            background-color: #e9ecef;
        }
        
        .full-media-item img, .full-media-item video {
            width: 100%;
            height: 100%;
            object-fit: cover;
            cursor: pointer;
        }
        
        .media-preview-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.9);
            z-index: 1003;
            display: none;
            justify-content: center;
            align-items: center;
            flex-direction: column;
        }
        
        .media-preview-content {
            max-width: 90%;
            max-height: 80%;
            position: relative;
        }
        
        .media-preview-content img, .media-preview-content video {
            width: 100%;
            height: auto;
            max-height: 70vh;
            border-radius: var(--border-radius);
        }
        
        .close-preview {
            position: absolute;
            top: 20px;
            right: 20px;
            background: none;
            border: none;
            color: white;
            font-size: 2rem;
            cursor: pointer;
        }
        
        .media-navigation {
            position: absolute;
            top: 50%;
            width: 100%;
            display: flex;
            justify-content: space-between;
            transform: translateY(-50%);
            padding: 0 20px;
        }
        
        .nav-btn {
            background-color: rgba(255,255,255,0.2);
            border: none;
            color: white;
            width: 50px;
            height: 50px;
            border-radius: 50%;
            font-size: 1.5rem;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .nav-btn:hover {
            background-color: rgba(255,255,255,0.4);
        }
        
        .media-counter {
            color: white;
            margin-top: 20px;
            font-size: 1.2rem;
        }
        
        .multi-file-upload {
            margin-top: 20px;
            padding: 20px;
            background-color: #f8f9fa;
            border-radius: var(--border-radius);
            border: 2px dashed #ddd;
        }
        
        .upload-area {
            text-align: center;
            padding: 30px;
        }
        
        .upload-icon {
            font-size: 3rem;
            color: var(--accent-color);
            margin-bottom: 15px;
        }
        
        .upload-text {
            margin-bottom: 20px;
            color: #555;
        }
        
        .file-list {
            margin-top: 20px;
            max-height: 200px;
            overflow-y: auto;
        }
        
        .file-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px 15px;
            background-color: white;
            border-radius: var(--border-radius);
            margin-bottom: 10px;
            border: 1px solid #eee;
        }
        
        .file-name {
            flex: 1;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }
        
        .file-size {
            color: #777;
            font-size: 0.9rem;
            margin-left: 15px;
        }
        
        .file-remove {
            background: none;
            border: none;
            color: var(--danger-color);
            cursor: pointer;
            font-size: 1.2rem;
            margin-right: 10px;
        }
        
        .patient-full-view {
            background-color: white;
            border-radius: var(--border-radius);
            box-shadow: var(--box-shadow);
            padding: 30px;
            margin-top: 30px;
        }
        
        .patient-header {
            display: flex;
            align-items: center;
            margin-bottom: 30px;
            padding-bottom: 20px;
            border-bottom: 2px solid #eee;
        }
        
        .patient-avatar {
            width: 150px;
            height: 150px;
            border-radius: 50%;
            overflow: hidden;
            margin-left: 30px;
            border: 5px solid var(--accent-color);
        }
        
        .patient-avatar img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        
        .patient-details h3 {
            color: var(--primary-color);
            font-size: 1.8rem;
            margin-bottom: 10px;
        }
        
        .patient-meta {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }
        
        .meta-item {
            background-color: #f8f9fa;
            padding: 15px;
            border-radius: var(--border-radius);
        }
        
        .meta-label {
            font-weight: 600;
            color: var(--primary-color);
            margin-bottom: 5px;
        }
        
        .meta-value {
            color: #555;
        }
        
        .section-title {
            color: var(--primary-color);
            margin: 30px 0 20px;
            padding-bottom: 10px;
            border-bottom: 1px solid #eee;
        }
        
        .patient-album {
            margin-top: 30px;
        }
        
        .album-controls {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }
        
        .album-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(180px, 1fr));
            gap: 15px;
        }
        
        .album-item {
            position: relative;
            border-radius: var(--border-radius);
            overflow: hidden;
            height: 180px;
            background-color: #e9ecef;
        }
        
        .album-item img, .album-item video {
            width: 100%;
            height: 100%;
            object-fit: cover;
            cursor: pointer;
        }
        
        .album-item-date {
            position: absolute;
            bottom: 0;
            right: 0;
            left: 0;
            background-color: rgba(0, 0, 0, 0.7);
            color: white;
            padding: 8px;
            font-size: 0.8rem;
            text-align: center;
        }
        
        .progress-container {
            width: 100%;
            background-color: #f0f0f0;
            border-radius: var(--border-radius);
            overflow: hidden;
            margin: 10px 0;
            display: none;
        }
        
        .progress-bar {
            height: 20px;
            background-color: var(--success-color);
            width: 0%;
            transition: width 0.3s ease;
            text-align: center;
            color: white;
            font-size: 0.8rem;
            line-height: 20px;
        }
        
        .uploaded-media-list {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
            gap: 10px;
            margin-top: 15px;
        }
        
        .uploaded-media-item {
            position: relative;
            border-radius: var(--border-radius);
            overflow: hidden;
            height: 120px;
            background-color: #f8f9fa;
        }
        
        .uploaded-media-item img, .uploaded-media-item video {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        
        .uploaded-media-remove {
            position: absolute;
            top: 5px;
            right: 5px;
            background-color: rgba(231, 76, 60, 0.9);
            color: white;
            border: none;
            border-radius: 50%;
            width: 25px;
            height: 25px;
            cursor: pointer;
            font-size: 0.8rem;
        }
        
        .surgery-media-sections {
            margin-top: 20px;
        }
        
        .media-section {
            margin-bottom: 25px;
            padding: 20px;
            background-color: #f8f9fa;
            border-radius: var(--border-radius);
            border-right: 4px solid var(--primary-color);
        }
        
        .media-section h4 {
            color: var(--primary-color);
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .media-section h4 i {
            font-size: 1.2rem;
        }
        
        .section-description {
            color: #666;
            font-size: 0.9rem;
            margin-bottom: 15px;
        }
        
        .patient-autocomplete {
            position: relative;
        }
        
        .autocomplete-dropdown {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            background-color: white;
            border: 1px solid #ddd;
            border-radius: var(--border-radius);
            max-height: 200px;
            overflow-y: auto;
            z-index: 1000;
            display: none;
            box-shadow: var(--box-shadow);
        }
        
        .autocomplete-item {
            padding: 10px 15px;
            cursor: pointer;
            border-bottom: 1px solid #eee;
            transition: background-color 0.2s;
        }
        
        .autocomplete-item:hover {
            background-color: #f0f0f0;
        }
        
        .autocomplete-item:last-child {
            border-bottom: none;
        }
        
        .patient-info-small {
            font-size: 0.8rem;
            color: #777;
            margin-top: 3px;
        }
        
        .tabs {
            display: flex;
            border-bottom: 2px solid #eee;
            margin-bottom: 20px;
        }
        
        .tab {
            padding: 12px 20px;
            cursor: pointer;
            font-weight: 600;
            color: #666;
            border-bottom: 3px solid transparent;
            transition: all 0.3s ease;
        }
        
        .tab:hover {
            color: var(--primary-color);
        }
        
        .tab.active {
            color: var(--primary-color);
            border-bottom-color: var(--primary-color);
        }
        
        .tab-content {
            display: none;
        }
        
        .tab-content.active {
            display: block;
            animation: fadeIn 0.5s ease;
        }
        
        .section-media-count {
            display: inline-block;
            background-color: var(--accent-color);
            color: white;
            padding: 2px 8px;
            border-radius: 10px;
            font-size: 0.8rem;
            margin-right: 10px;
        }
        
        /* الأنماط الجديدة للتاريخ والملاحظات */
        .history-container {
            margin-top: 30px;
            padding-top: 30px;
            border-top: 2px solid #eee;
        }
        
        .history-item {
            background-color: #f8f9fa;
            padding: 20px;
            border-radius: var(--border-radius);
            margin-bottom: 20px;
            border-right: 4px solid var(--accent-color);
        }
        
        .history-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 1px solid #ddd;
        }
        
        .history-date {
            font-weight: 600;
            color: var(--primary-color);
            font-size: 1.1rem;
        }
        
        .history-notes {
            margin-bottom: 20px;
            color: #555;
            line-height: 1.7;
        }
        
        .history-images {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 15px;
        }
        
        @media (min-width: 768px) {
            .history-images {
                grid-template-columns: repeat(4, 1fr);
            }
        }
        
        .history-image-container {
            position: relative;
            border-radius: var(--border-radius);
            overflow: hidden;
            height: 120px;
            background-color: #e9ecef;
        }
        
        .history-image-container img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            cursor: pointer;
        }
        
        .history-image-remove {
            position: absolute;
            top: 5px;
            right: 5px;
            background-color: rgba(231, 76, 60, 0.9);
            color: white;
            border: none;
            border-radius: 50%;
            width: 25px;
            height: 25px;
            cursor: pointer;
            font-size: 0.8rem;
        }
        
        .history-add-btn-container {
            text-align: center;
            margin-top: 20px;
        }
        
        .history-placeholder {
            text-align: center;
            padding: 30px;
            color: #777;
            background-color: #f8f9fa;
            border-radius: var(--border-radius);
            border: 2px dashed #ddd;
        }
        
        .history-form {
            background-color: #f8f9fa;
            padding: 25px;
            border-radius: var(--border-radius);
            margin-bottom: 30px;
        }
    </style>
</head>
<body>
    <header>
        <div class="container header-container">
            <div class="logo">
                <i class="fas fa-user-md"></i>
                <div>
                    <h1>دكتور صلاح السنوسي</h1>
                    <span>استشاري جراحة العظام والعمود الفقري</span>
                </div>
            </div>
            
            <nav>
                <ul>
                    <li><a href="#" class="nav-link active" data-page="home">الرئيسية</a></li>
                    <li><a href="#" class="nav-link" data-page="patients">المرضى</a></li>
                    <li><a href="#" class="nav-link" data-page="surgeries">العمليات</a></li>
                    <li><a href="#" class="nav-link" data-page="files">الملفات الرئيسية</a></li>
                    <li><a href="#" class="nav-link" data-page="add-patient">إضافة مريض</a></li>
                </ul>
            </nav>
            
            <button class="mobile-menu-btn">
                <i class="fas fa-bars"></i>
            </button>
        </div>
    </header>

    <main class="main-content">
        <div class="container">
            <section id="home" class="page active">
                <div class="page-header">
                    <h2>مرحباً دكتور صلاح</h2>
                    <div>تاريخ اليوم: <span id="current-date"></span></div>
                </div>
                
                <div class="doctor-profile">
                    <div class="profile-image-container">
                        <img src="" alt="دكتور صلاح السنوسي" class="profile-image" id="doctor-profile-image">
                        <div style="margin-top: 15px;">
                            <button class="btn" onclick="changeDoctorImage()">
                                <i class="fas fa-camera"></i> تغيير الصورة
                            </button>
                        </div>
                    </div>
                    
                    <div class="doctor-info">
                        <h2>دكتور صلاح السنوسي</h2>
                        <div style="margin: 15px 0; font-size: 1.1rem; line-height: 1.8;">
                            <p><i class="fas fa-check-circle" style="color: var(--secondary-color);"></i> استشاري جراحة العظام والعمود الفقري</p>
                            <p><i class="fas fa-graduation-cap" style="color: var(--secondary-color);"></i> دكتوراة جراحة العمود الفقري جامعة القاهرة</p>
                            <p><i class="fas fa-award" style="color: var(--secondary-color);"></i> خبرة تخصصية في جراحة العظام وتشوهات العمود الفقري</p>
                        </div>
                        <div class="doctor-specialties">
                            <div class="specialty">جراحة المفاصل الصناعية</div>
                            <div class="specialty">جراحات المناظير</div>
                            <div class="specialty">علاج الكسور</div>
                            <div class="specialty">جراحة العمود الفقري</div>
                            <div class="specialty">إصابات الملاعب</div>
                            <div class="specialty">جراحة الأطفال</div>
                        </div>
                    </div>
                </div>
                
                <div class="welcome-section">
                    <div class="form-container">
                        <h3 style="color: var(--primary-color); margin-bottom: 20px; text-align: center;">مرحباً بك في نظام إدارة العيادة</h3>
                        <p style="text-align: center; margin-bottom: 25px; color: #555; font-size: 1.1rem;">
                            يمكنك من خلال هذا النظام إدارة سجلات المرضى، وتسجيل العمليات الجراحية، والبحث السريع عن المعلومات.
                        </p>
                        
                        <div class="stats" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; margin-top: 30px;">
                            <div style="background: linear-gradient(135deg, #1a5f7a, #159895); color: white; padding: 20px; border-radius: var(--border-radius); text-align: center;">
                                <h4 style="font-size: 2.5rem; margin-bottom: 10px;" id="total-patients">0</h4>
                                <p>إجمالي المرضى</p>
                            </div>
                            <div style="background: linear-gradient(135deg, #159895, #57c5b6); color: white; padding: 20px; border-radius: var(--border-radius); text-align: center;">
                                <h4 style="font-size: 2.5rem; margin-bottom: 10px;" id="total-surgeries">0</h4>
                                <p>إجمالي العمليات</p>
                            </div>
                            <div style="background: linear-gradient(135deg, #57c5b6, #86d9cb); color: white; padding: 20px; border-radius: var(--border-radius); text-align: center;">
                                <h4 style="font-size: 2.5rem; margin-bottom: 10px;" id="today-appointments">0</h4>
                                <p>مواعيد اليوم</p>
                            </div>
                            <div style="background: linear-gradient(135deg, #86d9cb, #a8e6cf); color: white; padding: 20px; border-radius: var(--border-radius); text-align: center;">
                                <h4 style="font-size: 2.5rem; margin-bottom: 10px;" id="total-media">0</h4>
                                <p>إجمالي الوسائط</p>
                            </div>
                        </div>
                        
                        <div style="margin-top: 30px;">
                            <h4 style="color: var(--primary-color); margin-bottom: 15px;">الوصول السريع</h4>
                            <div style="display: flex; gap: 15px; flex-wrap: wrap;">
                                <button class="btn" onclick="showPage('patients')">
                                    <i class="fas fa-users"></i> قائمة المرضى
                                </button>
                                <button class="btn" onclick="showPage('surgeries')">
                                    <i class="fas fa-procedures"></i> سجل العمليات
                                </button>
                                <button class="btn" onclick="showPage('add-patient')">
                                    <i class="fas fa-user-plus"></i> إضافة مريض جديد
                                </button>
                                <button class="btn" onclick="showPage('files')">
                                    <i class="fas fa-folder-open"></i> الملفات الرئيسية
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </section>

            <section id="patients" class="page">
                <div class="page-header">
                    <h2><i class="fas fa-users"></i> إدارة المرضى</h2>
                    <button class="btn btn-primary" onclick="showPage('add-patient')">
                        <i class="fas fa-user-plus"></i> إضافة مريض جديد
                    </button>
                </div>
                
                <div class="search-container">
                    <div class="search-box">
                        <input type="text" id="patient-search" placeholder="ابحث عن مريض بالاسم، التشخيص، الهاتف، العنوان...">
                        <button><i class="fas fa-search"></i></button>
                    </div>
                </div>
                
                <div class="table-container">
                    <table id="patients-table">
                        <thead>
                            <tr>
                                <th>الصورة</th>
                                <th>الاسم</th>
                                <th>العمر</th>
                                <th>الهاتف</th>
                                <th>التشخيص</th>
                                <th>الوسائط</th>
                                <th>آخر زيارة</th>
                                <th>الإجراءات</th>
                            </tr>
                        </thead>
                        <tbody id="patients-table-body">
                        </tbody>
                    </table>
                </div>
            </section>

            <section id="surgeries" class="page">
                <div class="page-header">
                    <h2><i class="fas fa-procedures"></i> سجل العمليات الجراحية</h2>
                    <button class="btn btn-primary" onclick="showAddSurgeryForm()">
                        <i class="fas fa-plus-circle"></i> إضافة عملية جديدة
                    </button>
                </div>
                
                <div class="search-container">
                    <div class="search-box">
                        <input type="text" id="surgery-search" placeholder="ابحث عن عملية باسم المريض، نوع العملية، التاريخ...">
                        <button><i class="fas fa-search"></i></button>
                    </div>
                </div>
                
                <div class="cards-container" id="surgeries-container">
                </div>
            </section>

            <section id="files" class="page">
                <div class="page-header">
                    <h2><i class="fas fa-folder"></i> الملفات الرئيسية</h2>
                    <p>الملفات الرئيسية للمرضى والعمليات</p>
                </div>
                
                <div class="main-files-container">
                    <div class="main-file-card" onclick="showPage('patients')">
                        <div class="main-file-icon">
                            <i class="fas fa-users"></i>
                        </div>
                        <h3>ملف المرضى الرئيسي</h3>
                        <p>يحتوي على جميع سجلات المرضى مع إمكانية البحث والتصفية</p>
                        <div class="file-count" id="patients-count">0 ملف</div>
                    </div>
                    
                    <div class="main-file-card" onclick="showPage('surgeries')">
                        <div class="main-file-icon">
                            <i class="fas fa-procedures"></i>
                        </div>
                        <h3>ملف العمليات الرئيسي</h3>
                        <p>يحتوي على جميع سجلات العمليات الجراحية مع تفاصيل كل عملية</p>
                        <div class="file-count" id="surgeries-count">0 ملف</div>
                    </div>
                </div>
                
                <div style="margin-top: 40px;">
                    <h3 style="color: var(--primary-color); margin-bottom: 20px;">ملفات المرضى الفردية</h3>
                    <div class="files-container" id="patient-files-container">
                    </div>
                </div>
            </section>

            <section id="add-patient" class="page">
                <div class="page-header">
                    <h2 id="add-patient-title"><i class="fas fa-user-plus"></i> إضافة مريض جديد</h2>
                    <button class="btn" id="add-patient-back-btn" onclick="showPage('patients')">
                        <i class="fas fa-arrow-right"></i> العودة لقائمة المرضى
                    </button>
                </div>
                
                <div class="form-container">
                    <form id="add-patient-form">
                        <div class="image-upload-container">
                            <label for="patient-image-upload" class="upload-label">
                                <i class="fas fa-camera"></i> اختر صورة شخصية للمريض
                            </label>
                            <input type="file" id="patient-image-upload" class="upload-input" accept="image/jpeg,image/jpg,image/png,image/webp">
                            <img id="patient-image-preview" class="upload-preview" alt="معاينة صورة المريض">
                        </div>
                        
                        <div class="form-row">
                            <div class="form-group">
                                <label for="patient-name">الاسم بالكامل *</label>
                                <input type="text" id="patient-name" class="form-control" required>
                            </div>
                            <div class="form-group">
                                <label for="patient-age">العمر *</label>
                                <input type="number" id="patient-age" class="form-control" required min="1" max="120">
                            </div>
                        </div>
                        
                        <div class="form-row">
                            <div class="form-group">
                                <label for="patient-phone">رقم الهاتف *</label>
                                <input type="tel" id="patient-phone" class="form-control" required>
                            </div>
                            <div class="form-group">
                                <label for="patient-gender">الجنس</label>
                                <select id="patient-gender" class="form-control">
                                    <option value="ذكر">ذكر</option>
                                    <option value="أنثى">أنثى</option>
                                </select>
                            </div>
                        </div>
                        
                        <div class="form-row">
                            <div class="form-group">
                                <label for="patient-blood-type">فصيلة الدم</label>
                                <select id="patient-blood-type" class="form-control">
                                    <option value="غير معروف">غير معروف</option>
                                    <option value="A+">A+</option>
                                    <option value="A-">A-</option>
                                    <option value="B+">B+</option>
                                    <option value="B-">B-</option>
                                    <option value="O+">O+</option>
                                    <option value="O-">O-</option>
                                    <option value="AB+">AB+</option>
                                    <option value="AB-">AB-</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label for="patient-date">تاريخ التسجيل *</label>
                                <input type="date" id="patient-date" class="form-control" required>
                            </div>
                        </div>
                        
                        <div class="form-group">
                            <label for="patient-address">العنوان</label>
                            <input type="text" id="patient-address" class="form-control">
                        </div>
                        
                        <div class="form-group">
                            <label for="patient-diagnosis">التشخيص الأولي *</label>
                            <textarea id="patient-diagnosis" class="form-control" rows="3" required></textarea>
                        </div>
                        
                        <div class="form-group">
                            <label for="patient-notes">ملاحظات إضافية</label>
                            <textarea id="patient-notes" class="form-control" rows="3"></textarea>
                        </div>
                        
                        <!-- قسم التاريخ والملاحظات الإضافية -->
                        <div class="history-container">
                            <h3 style="color: var(--primary-color); margin-bottom: 20px;">
                                <i class="fas fa-history"></i> تاريخ وملاحظات إضافية
                            </h3>
                            
                            <div id="history-items-container">
                                <!-- سيتم عرض عناصر التاريخ والملاحظات هنا -->
                            </div>
                            
                            <div class="history-add-btn-container">
                                <button type="button" id="add-history-btn" class="btn btn-primary">
                                    <i class="fas fa-plus"></i> إضافة تاريخ وملاحظة جديدة
                                </button>
                            </div>
                        </div>
                        
                        <div class="multi-file-upload">
                            <div class="upload-area" id="patient-files-upload-area">
                                <div class="upload-icon">
                                    <i class="fas fa-cloud-upload-alt"></i>
                                </div>
                                <div class="upload-text">
                                    <h4>اسحب وأفلت ملفات الوسائط هنا</h4>
                                    <p>أو انقر لاختيار ملفات</p>
                                    <p>يمكنك رفع أكثر من 20 صورة وفيديو لكل مريض</p>
                                    <p>الصيغ المدعومة: JPG, PNG, WebP, MP4, WebM</p>
                                </div>
                                <label for="patient-files-upload" class="upload-label">
                                    <i class="fas fa-folder-open"></i> اختيار ملفات متعددة
                                </label>
                                <input type="file" id="patient-files-upload" class="upload-input" accept="image/jpeg,image/jpg,image/png,image/webp,video/mp4,video/webm" multiple>
                            </div>
                            
                            <div class="progress-container" id="patient-progress-container">
                                <div class="progress-bar" id="patient-progress-bar">0%</div>
                            </div>
                            
                            <div class="uploaded-media-list" id="patient-uploaded-media">
                            </div>
                            
                            <div class="file-list" id="patient-files-list">
                            </div>
                        </div>
                        
                        <div style="text-align: center; margin-top: 30px;">
                            <button type="button" id="patient-submit-btn" class="btn btn-primary" style="padding: 12px 40px; font-size: 1.1rem;">
                                <i class="fas fa-save"></i> حفظ بيانات المريض
                            </button>
                            <button type="button" class="btn btn-warning" onclick="clearPatientForm()" style="padding: 12px 40px; font-size: 1.1rem; margin-right: 15px;">
                                <i class="fas fa-redo"></i> مسح النموذج
                            </button>
                        </div>
                    </form>
                </div>
            </section>
        </div>
    </main>

    <footer>
        <div class="container footer-content">
            <div class="footer-logo">
                <h3>دكتور صلاح السنوسي</h3>
                <span>استشاري جراحة العظام والعمود الفقري</span>
            </div>
            
            <div class="contact-info">
                <p><i class="fas fa-map-marker-alt"></i> العنوان: اسيوط المركز التجاري الدولي </p>
            </div>
        </div>
    </footer>

    <div id="surgery-modal" class="modal-overlay" style="display: none;">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="surgery-modal-title">إضافة عملية جراحية جديدة</h3>
                <button class="modal-close" onclick="closeSurgeryModal()">&times;</button>
            </div>
            
            <form id="surgery-form">
                <input type="hidden" id="surgery-id">
                
                <div class="form-row">
                    <div class="form-group patient-autocomplete">
                        <label for="modal-surgery-patient">اسم المريض *</label>
                        <input type="text" id="modal-surgery-patient" class="form-control" placeholder="اكتب اسم المريض للبحث..." required>
                        <div class="autocomplete-dropdown" id="patient-autocomplete-dropdown">
                        </div>
                        <input type="hidden" id="modal-surgery-patient-id">
                    </div>
                    <div class="form-group">
                        <label for="modal-surgery-type">نوع العملية *</label>
                        <input type="text" id="modal-surgery-type" class="form-control" required>
                    </div>
                </div>
                
                <div class="form-row">
                    <div class="form-group">
                        <label for="modal-surgery-date">تاريخ العملية *</label>
                        <input type="date" id="modal-surgery-date" class="form-control" required>
                    </div>
                    <div class="form-group">
                        <label for="modal-surgery-duration">مدة العملية (ساعات)</label>
                        <input type="number" id="modal-surgery-duration" class="form-control" min="0.5" max="24" step="0.5" value="1">
                    </div>
                </div>
                
                <div class="form-group">
                    <label for="modal-surgery-details">تفاصيل العملية *</label>
                    <textarea id="modal-surgery-details" class="form-control" rows="4" required></textarea>
                </div>
                
                <div class="form-group">
                    <label for="modal-surgery-surgeon">الجراح الرئيسي</label>
                    <input type="text" id="modal-surgery-surgeon" class="form-control" value="دكتور صلاح السنوسي">
                </div>
                
                <div class="surgery-media-sections">
                    <div class="tabs" id="surgery-media-tabs">
                        <div class="tab active" data-tab="before">صور قبل العملية</div>
                        <div class="tab" data-tab="after">صور بعد العملية</div>
                        <div class="tab" data-tab="during">صور أثناء المتابعة</div>
                    </div>
                    
                    <div class="tab-content active" id="before-tab">
                        <div class="media-section">
                            <h4><i class="fas fa-camera"></i> صور قبل العملية <span class="section-media-count" id="before-count">0</span></h4>
                            <p class="section-description">صور الأشعات والتشخيص قبل إجراء العملية</p>
                            
                            <div class="multi-file-upload">
                                <div class="upload-area" id="before-surgery-upload-area">
                                    <div class="upload-icon">
                                        <i class="fas fa-cloud-upload-alt"></i>
                                    </div>
                                    <div class="upload-text">
                                        <h4>اسحب وأفلت صور قبل العملية هنا</h4>
                                        <p>أو انقر لاختيار ملفات</p>
                                        <p>الصيغ المدعومة: JPG, PNG, WebP</p>
                                    </div>
                                    <label for="before-surgery-upload" class="upload-label">
                                        <i class="fas fa-folder-open"></i> اختيار صور قبل العملية
                                    </label>
                                    <input type="file" id="before-surgery-upload" class="upload-input" accept="image/jpeg,image/jpg,image/png,image/webp" multiple>
                                </div>
                                
                                <div class="progress-container" id="before-progress-container">
                                    <div class="progress-bar" id="before-progress-bar">0%</div>
                                </div>
                                
                                <div class="uploaded-media-list" id="before-uploaded-media">
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="tab-content" id="after-tab">
                        <div class="media-section">
                            <h4><i class="fas fa-camera"></i> صور بعد العملية <span class="section-media-count" id="after-count">0</span></h4>
                            <p class="section-description">صور الأشعات والنتائج بعد إجراء العملية</p>
                            
                            <div class="multi-file-upload">
                                <div class="upload-area" id="after-surgery-upload-area">
                                    <div class="upload-icon">
                                        <i class="fas fa-cloud-upload-alt"></i>
                                    </div>
                                    <div class="upload-text">
                                        <h4>اسحب وأفلت صور بعد العملية هنا</h4>
                                        <p>أو انقر لاختيار ملفات</p>
                                        <p>الصيغ المدعومة: JPG, PNG, WebP</p>
                                    </div>
                                    <label for="after-surgery-upload" class="upload-label">
                                        <i class="fas fa-folder-open"></i> اختيار صور بعد العملية
                                    </label>
                                    <input type="file" id="after-surgery-upload" class="upload-input" accept="image/jpeg,image/jpg,image/png,image/webp" multiple>
                                </div>
                                
                                <div class="progress-container" id="after-progress-container">
                                    <div class="progress-bar" id="after-progress-bar">0%</div>
                                </div>
                                
                                <div class="uploaded-media-list" id="after-uploaded-media">
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="tab-content" id="during-tab">
                        <div class="media-section">
                            <h4><i class="fas fa-camera"></i> صور أثناء المتابعة <span class="section-media-count" id="during-count">0</span></h4>
                            <p class="section-description">صور المتابعة والعلاج الطبيعي بعد العملية</p>
                            
                            <div class="multi-file-upload">
                                <div class="upload-area" id="during-surgery-upload-area">
                                    <div class="upload-icon">
                                        <i class="fas fa-cloud-upload-alt"></i>
                                    </div>
                                    <div class="upload-text">
                                        <h4>اسحب وأفلت صور المتابعة هنا</h4>
                                        <p>أو انقر لاختيار ملفات</p>
                                        <p>الصيغ المدعومة: JPG, PNG, WebP, MP4, WebM</p>
                                    </div>
                                    <label for="during-surgery-upload" class="upload-label">
                                        <i class="fas fa-folder-open"></i> اختيار صور المتابعة
                                    </label>
                                    <input type="file" id="during-surgery-upload" class="upload-input" accept="image/jpeg,image/jpg,image/png,image/webp,video/mp4,video/webm" multiple>
                                </div>
                                
                                <div class="progress-container" id="during-progress-container">
                                    <div class="progress-bar" id="during-progress-bar">0%</div>
                                </div>
                                
                                <div class="uploaded-media-list" id="during-uploaded-media">
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="form-group">
                    <label for="modal-surgery-notes">ملاحظات إضافية</label>
                    <textarea id="modal-surgery-notes" class="form-control" rows="3"></textarea>
                </div>
                
                <div style="display: flex; gap: 15px; justify-content: center; margin-top: 30px;">
                    <button type="submit" class="btn btn-primary" id="surgery-submit-btn">
                        <i class="fas fa-save"></i> حفظ العملية
                    </button>
                    <button type="button" class="btn btn-danger" onclick="closeSurgeryModal()">
                        <i class="fas fa-times"></i> إلغاء
                    </button>
                </div>
            </form>
        </div>
    </div>

    <div id="patient-full-modal" class="modal-overlay" style="display: none;">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="patient-full-modal-title">ملف المريض الكامل</h3>
                <button class="modal-close" onclick="closePatientFullModal()">&times;</button>
            </div>
            
            <div id="patient-full-content">
            </div>
        </div>
    </div>

    <div class="media-preview-modal" id="media-preview-modal">
        <button class="close-preview" onclick="closeMediaPreview()">&times;</button>
        <div class="media-navigation">
            <button class="nav-btn" id="prev-media">
                <i class="fas fa-chevron-right"></i>
            </button>
            <button class="nav-btn" id="next-media">
                <i class="fas fa-chevron-left"></i>
            </button>
        </div>
        <div class="media-preview-content">
        </div>
        <div class="media-counter" id="media-counter">1 / 1</div>
    </div>

    <div id="notification" class="notification" style="display: none;"></div>

    <script>
        let patients = JSON.parse(localStorage.getItem('clinic-patients')) || [];
        let surgeries = JSON.parse(localStorage.getItem('clinic-surgeries')) || [];
        let doctorImage = localStorage.getItem('doctor-profile-image') || "";
        let editingPatientId = null;
        
        let tempPatientFiles = [];
        let tempSurgeryFiles = {
            before: [],
            after: [],
            during: []
        };
        
        let patientHistory = []; // لتخزين التاريخ والملاحظات الإضافية
        
        let currentMediaPreview = {
            items: [],
            currentIndex: 0
        };
        
        function saveData() {
            try {
                localStorage.setItem('clinic-patients', JSON.stringify(patients));
                localStorage.setItem('clinic-surgeries', JSON.stringify(surgeries));
                if (doctorImage) {
                    localStorage.setItem('doctor-profile-image', doctorImage);
                }
            } catch (error) {
                console.error('حدث خطأ أثناء حفظ البيانات:', error);
                showNotification('حدث خطأ أثناء حفظ البيانات', 'error');
            }
        }
        
        document.addEventListener('DOMContentLoaded', function() {
            const today = new Date();
            const dateString = today.toLocaleDateString('ar-EG', {
                weekday: 'long',
                year: 'numeric',
                month: 'long',
                day: 'numeric'
            });
            document.getElementById('current-date').textContent = dateString;
            
            if (doctorImage) {
                document.getElementById('doctor-profile-image').src = doctorImage;
            }
            
            document.getElementById('patient-date').value = today.toISOString().split('T')[0];
            
            loadInitialData();
            updateStats();
            loadPatientsTable();
            loadSurgeriesCards();
            loadPatientFiles();
            setupEventListeners();
            setupSurgeryMediaTabs();
        });
        
        function setupSurgeryMediaTabs() {
            const tabs = document.querySelectorAll('.tab');
            tabs.forEach(tab => {
                tab.addEventListener('click', function() {
                    const tabId = this.getAttribute('data-tab');
                    
                    tabs.forEach(t => t.classList.remove('active'));
                    
                    this.classList.add('active');
                    
                    document.querySelectorAll('.tab-content').forEach(content => {
                        content.classList.remove('active');
                    });
                    
                    document.getElementById(`${tabId}-tab`).classList.add('active');
                });
            });
        }
        
        function loadInitialData() {
            if (patients.length === 0) {
                patients = [
                    {
                        id: 1,
                        name: "أحمد محمد",
                        age: 45,
                        phone: "01234567891",
                        gender: "ذكر",
                        bloodType: "O+",
                        address: "حي المقطم، القاهرة",
                        diagnosis: "كسور في عظمة الفخذ بسبب حادث سير",
                        notes: "مريض يعاني من هشاشة العظام، يحتاج متابعة دورية",
                        registrationDate: "2023-05-15",
                        lastVisit: "2024-01-10",
                        image: "",
                        mediaFiles: [],
                        history: [] // إضافة مصفوفة التاريخ
                    },
                    {
                        id: 2,
                        name: "سارة محمود",
                        age: 32,
                        phone: "01234567892",
                        gender: "أنثى",
                        bloodType: "A+",
                        address: "المعادي، القاهرة",
                        diagnosis: "إصابة في الرباط الصليبي الأمامي للركبة اليسرى",
                        notes: "لاعبة كرة قدم محترفة، تحتاج إلى برنامج تأهيلي مكثف",
                        registrationDate: "2023-07-22",
                        lastVisit: "2024-01-05",
                        image: "",
                        mediaFiles: [],
                        history: [] // إضافة مصفوفة التاريخ
                    }
                ];
            }
            
            if (surgeries.length === 0) {
                surgeries = [
                    {
                        id: 1,
                        patientId: 1,
                        patientName: "أحمد محمد",
                        type: "ترقيع عظمة الفخذ",
                        date: "2023-06-05",
                        duration: 3.5,
                        details: "جراحة لترقيع كسر في عظمة الفخذ الأيمن باستخدام شرائح ومسامير معدنية",
                        surgeon: "دكتور صلاح السنوسي",
                        notes: "تمت العملية بنجاح، المريض يتعافى بشكل جيد",
                        mediaFiles: {
                            before: [],
                            after: [],
                            during: []
                        }
                    }
                ];
            }
            
            saveData();
        }
        
        function setupEventListeners() {
            document.querySelectorAll('.nav-link').forEach(link => {
                link.addEventListener('click', function(e) {
                    e.preventDefault();
                    const pageId = this.getAttribute('data-page');
                    showPage(pageId);
                });
            });
            
            document.getElementById('patient-search').addEventListener('input', function() {
                searchPatients(this.value);
            });
            
            document.getElementById('surgery-search').addEventListener('input', function() {
                searchSurgeries(this.value);
            });
            
            document.getElementById('patient-submit-btn').addEventListener('click', function() {
                if (editingPatientId) {
                    updatePatient(editingPatientId);
                } else {
                    addNewPatient();
                }
            });
            
            document.getElementById('surgery-form').addEventListener('submit', function(e) {
                e.preventDefault();
                saveSurgery();
            });
            
            document.getElementById('patient-image-upload').addEventListener('change', function(e) {
                handleImageUpload(e.target.files[0], 'patient');
            });
            
            document.getElementById('patient-files-upload').addEventListener('change', function(e) {
                handleMultiFileUpload(e.target.files, 'patient');
            });
            
            document.getElementById('before-surgery-upload').addEventListener('change', function(e) {
                handleSurgeryMediaUpload(e.target.files, 'before');
            });
            
            document.getElementById('after-surgery-upload').addEventListener('change', function(e) {
                handleSurgeryMediaUpload(e.target.files, 'after');
            });
            
            document.getElementById('during-surgery-upload').addEventListener('change', function(e) {
                handleSurgeryMediaUpload(e.target.files, 'during');
            });
            
            document.getElementById('modal-surgery-patient').addEventListener('input', function() {
                searchPatientsForAutocomplete(this.value);
            });
            
            document.getElementById('add-history-btn').addEventListener('click', function() {
                addNewHistoryItem();
            });
            
            setupDragAndDrop('patient-files-upload-area', 'patient-files-upload');
            setupDragAndDrop('before-surgery-upload-area', 'before-surgery-upload');
            setupDragAndDrop('after-surgery-upload-area', 'after-surgery-upload');
            setupDragAndDrop('during-surgery-upload-area', 'during-surgery-upload');
            
            document.getElementById('prev-media').addEventListener('click', function() {
                navigateMedia(-1);
            });
            
            document.getElementById('next-media').addEventListener('click', function() {
                navigateMedia(1);
            });
            
            document.addEventListener('keydown', function(e) {
                if (e.key === 'Escape') {
                    closeMediaPreview();
                }
            });
        }
        
        function addNewHistoryItem() {
            const historyId = Date.now();
            
            const historyItem = {
                id: historyId,
                date: new Date().toISOString().split('T')[0],
                notes: '',
                images: []
            };
            
            patientHistory.push(historyItem);
            renderHistoryItem(historyItem);
        }
        
        function renderHistoryItem(historyItem) {
            const container = document.getElementById('history-items-container');
            
            const historyDiv = document.createElement('div');
            historyDiv.className = 'history-item';
            historyDiv.setAttribute('data-history-id', historyItem.id);
            
            historyDiv.innerHTML = `
                <div class="history-header">
                    <div class="history-date">تاريخ: ${historyItem.date}</div>
                    <button type="button" class="btn btn-danger btn-sm" onclick="removeHistoryItem(${historyItem.id})">
                        <i class="fas fa-trash"></i> حذف
                    </button>
                </div>
                <div class="form-group">
                    <label>ملاحظات</label>
                    <textarea class="form-control history-notes-input" rows="3" placeholder="أدخل الملاحظات..." onchange="updateHistoryNotes(${historyItem.id}, this.value)">${historyItem.notes}</textarea>
                </div>
                <div class="form-group">
                    <label>صور إضافية (4 صور كحد أقصى)</label>
                    <div class="history-images" id="history-images-${historyItem.id}">
                        ${historyItem.images.map((image, index) => `
                            <div class="history-image-container">
                                <img src="${image.data}" alt="صورة إضافية">
                                <button type="button" class="history-image-remove" onclick="removeHistoryImage(${historyItem.id}, ${index})">
                                    <i class="fas fa-times"></i>
                                </button>
                            </div>
                        `).join('')}
                    </div>
                    ${historyItem.images.length < 4 ? `
                        <div style="margin-top: 15px;">
                            <label for="history-image-upload-${historyItem.id}" class="upload-label" style="display: inline-block;">
                                <i class="fas fa-camera"></i> إضافة صورة
                            </label>
                            <input type="file" id="history-image-upload-${historyItem.id}" class="upload-input" accept="image/jpeg,image/jpg,image/png,image/webp" onchange="handleHistoryImageUpload(${historyItem.id}, this.files)">
                            <small style="display: block; color: #777; margin-top: 5px;">يمكنك إضافة حتى 4 صور</small>
                        </div>
                    ` : '<p style="color: var(--warning-color);"><i class="fas fa-info-circle"></i> تم الوصول إلى الحد الأقصى للصور (4)</p>'}
                </div>
            `;
            
            container.appendChild(historyDiv);
        }
        
        function handleHistoryImageUpload(historyId, files) {
            if (!files || files.length === 0) return;
            
            const historyItem = patientHistory.find(item => item.id === historyId);
            if (!historyItem) return;
            
            const remainingSlots = 4 - historyItem.images.length;
            if (remainingSlots <= 0) {
                showNotification('تم الوصول إلى الحد الأقصى للصور (4)', 'warning');
                return;
            }
            
            const file = files[0];
            const allowedTypes = ['image/jpeg', 'image/jpg', 'image/png', 'image/webp'];
            const maxSize = 5 * 1024 * 1024; // 5MB
            
            if (!allowedTypes.includes(file.type)) {
                showNotification('نوع الملف غير مدعوم. يُرجى استخدام JPG, PNG أو WebP', 'error');
                return;
            }
            
            if (file.size > maxSize) {
                showNotification('حجم الصورة كبير جداً. الحد الأقصى 5MB', 'error');
                return;
            }
            
            const reader = new FileReader();
            reader.onload = function(e) {
                historyItem.images.push({
                    id: Date.now(),
                    name: file.name,
                    data: e.target.result
                });
                
                renderHistoryItems();
                showNotification('تم إضافة الصورة بنجاح', 'success');
            };
            
            reader.onerror = function() {
                showNotification('حدث خطأ أثناء قراءة الملف', 'error');
            };
            
            reader.readAsDataURL(file);
        }
        
        function removeHistoryImage(historyId, imageIndex) {
            if (confirm('هل أنت متأكد من حذف هذه الصورة؟')) {
                const historyItem = patientHistory.find(item => item.id === historyId);
                if (historyItem) {
                    historyItem.images.splice(imageIndex, 1);
                    renderHistoryItems();
                    showNotification('تم حذف الصورة', 'info');
                }
            }
        }
        
        function updateHistoryNotes(historyId, notes) {
            const historyItem = patientHistory.find(item => item.id === historyId);
            if (historyItem) {
                historyItem.notes = notes;
            }
        }
        
        function removeHistoryItem(historyId) {
            if (confirm('هل أنت متأكد من حذف هذا السجل؟')) {
                patientHistory = patientHistory.filter(item => item.id !== historyId);
                renderHistoryItems();
                showNotification('تم حذف السجل', 'info');
            }
        }
        
        function renderHistoryItems() {
            const container = document.getElementById('history-items-container');
            container.innerHTML = '';
            
            if (patientHistory.length === 0) {
                container.innerHTML = `
                    <div class="history-placeholder">
                        <i class="fas fa-calendar-plus" style="font-size: 3rem; margin-bottom: 15px; color: #adb5bd;"></i>
                        <h4>لا توجد سجلات تاريخية</h4>
                        <p>انقر على زر "إضافة تاريخ وملاحظة جديدة" لإضافة السجل الأول</p>
                    </div>
                `;
                return;
            }
            
            patientHistory.forEach(item => {
                renderHistoryItem(item);
            });
        }
        
        function setupDragAndDrop(dropAreaId, inputId) {
            const dropArea = document.getElementById(dropAreaId);
            const fileInput = document.getElementById(inputId);
            
            if (!dropArea || !fileInput) return;
            
            dropArea.addEventListener('dragover', function(e) {
                e.preventDefault();
                dropArea.style.backgroundColor = '#e8f4f8';
            });
            
            dropArea.addEventListener('dragleave', function(e) {
                e.preventDefault();
                dropArea.style.backgroundColor = '';
            });
            
            dropArea.addEventListener('drop', function(e) {
                e.preventDefault();
                dropArea.style.backgroundColor = '';
                
                if (e.dataTransfer.files.length) {
                    fileInput.files = e.dataTransfer.files;
                    
                    const event = new Event('change', { bubbles: true });
                    fileInput.dispatchEvent(event);
                }
            });
        }
        
        function searchPatientsForAutocomplete(query) {
            const dropdown = document.getElementById('patient-autocomplete-dropdown');
            
            if (!query.trim()) {
                dropdown.style.display = 'none';
                return;
            }
            
            const filteredPatients = patients.filter(patient => {
                return patient.name.toLowerCase().includes(query.toLowerCase()) ||
                       patient.phone.includes(query);
            });
            
            if (filteredPatients.length === 0) {
                dropdown.innerHTML = '<div class="autocomplete-item">لا توجد نتائج</div>';
                dropdown.style.display = 'block';
                return;
            }
            
            dropdown.innerHTML = filteredPatients.map(patient => `
                <div class="autocomplete-item" data-patient-id="${patient.id}">
                    <div>${patient.name}</div>
                    <div class="patient-info-small">العمر: ${patient.age} سنة | الهاتف: ${patient.phone}</div>
                </div>
            `).join('');
            
            dropdown.style.display = 'block';
            
            document.querySelectorAll('.autocomplete-item[data-patient-id]').forEach(item => {
                item.addEventListener('click', function() {
                    const patientId = parseInt(this.getAttribute('data-patient-id'));
                    const patient = patients.find(p => p.id === patientId);
                    
                    if (patient) {
                        document.getElementById('modal-surgery-patient').value = patient.name;
                        document.getElementById('modal-surgery-patient-id').value = patient.id;
                        dropdown.style.display = 'none';
                    }
                });
            });
        }
        
        function searchPatients(query) {
            if (!query.trim()) {
                loadPatientsTable();
                return;
            }
            
            const filteredPatients = patients.filter(patient => {
                return patient.name.toLowerCase().includes(query.toLowerCase()) ||
                       patient.phone.includes(query) ||
                       patient.diagnosis.toLowerCase().includes(query.toLowerCase()) ||
                       (patient.address && patient.address.toLowerCase().includes(query.toLowerCase()));
            });
            
            loadPatientsTable(filteredPatients);
        }
        
        function searchSurgeries(query) {
            if (!query.trim()) {
                loadSurgeriesCards();
                return;
            }
            
            const filteredSurgeries = surgeries.filter(surgery => {
                return surgery.type.toLowerCase().includes(query.toLowerCase()) ||
                       surgery.patientName.toLowerCase().includes(query.toLowerCase()) ||
                       surgery.details.toLowerCase().includes(query.toLowerCase()) ||
                       surgery.date.includes(query);
            });
            
            loadSurgeriesCards(filteredSurgeries);
        }
        
        function handleImageUpload(file, type) {
            if (!file) return;
            
            const allowedTypes = ['image/jpeg', 'image/jpg', 'image/png', 'image/webp'];
            if (!allowedTypes.includes(file.type)) {
                showNotification('نوع الملف غير مدعوم. يُرجى استخدام JPG, PNG أو WebP', 'error');
                return;
            }
            
            const maxSize = 5 * 1024 * 1024;
            if (file.size > maxSize) {
                showNotification('حجم الصورة كبير جداً. الحد الأقصى 5MB', 'error');
                return;
            }
            
            const reader = new FileReader();
            reader.onload = function(e) {
                if (type === 'patient') {
                    const preview = document.getElementById('patient-image-preview');
                    preview.src = e.target.result;
                    
                    tempPatientFiles[0] = {
                        id: Date.now(),
                        name: file.name,
                        size: formatFileSize(file.size),
                        type: 'image',
                        data: e.target.result
                    };
                } else if (type === 'doctor') {
                    doctorImage = e.target.result;
                    document.getElementById('doctor-profile-image').src = doctorImage;
                    saveData();
                    showNotification('تم تغيير صورة الدكتور بنجاح', 'success');
                }
            };
            
            reader.onerror = function() {
                showNotification('حدث خطأ أثناء قراءة الملف', 'error');
            };
            
            reader.readAsDataURL(file);
        }
        
        function handleMultiFileUpload(files, type) {
            if (!files || files.length === 0) return;
            
            const allowedImageTypes = ['image/jpeg', 'image/jpg', 'image/png', 'image/webp'];
            const allowedVideoTypes = ['video/mp4', 'video/webm'];
            const maxFiles = 50;
            const maxSize = 50 * 1024 * 1024;
            
            const progressContainer = document.getElementById(`${type}-progress-container`);
            const progressBar = document.getElementById(`${type}-progress-bar`);
            
            progressContainer.style.display = 'block';
            progressBar.style.width = '0%';
            progressBar.textContent = '0%';
            
            let uploadedCount = 0;
            const totalFiles = Math.min(files.length, maxFiles);
            
            for (let i = 0; i < totalFiles; i++) {
                const file = files[i];
                const fileType = file.type;
                
                if (!allowedImageTypes.includes(fileType) && !allowedVideoTypes.includes(fileType)) {
                    showNotification(`نوع الملف ${file.name} غير مدعوم`, 'error');
                    continue;
                }
                
                if (file.size > maxSize) {
                    showNotification(`الملف ${file.name} يتجاوز الحجم المسموح به (50MB)`, 'error');
                    continue;
                }
                
                const reader = new FileReader();
                reader.onload = function(e) {
                    const fileId = Date.now() + i;
                    const mediaType = fileType.startsWith('image/') ? 'image' : 'video';
                    
                    const mediaItem = {
                        id: fileId,
                        name: file.name,
                        size: formatFileSize(file.size),
                        type: mediaType,
                        data: e.target.result
                    };
                    
                    tempPatientFiles.push(mediaItem);
                    
                    uploadedCount++;
                    const progressPercent = Math.round((uploadedCount / totalFiles) * 100);
                    progressBar.style.width = progressPercent + '%';
                    progressBar.textContent = progressPercent + '%';
                    
                    displayUploadedMedia(mediaItem, 'patient');
                    
                    if (uploadedCount === totalFiles) {
                        setTimeout(() => {
                            progressContainer.style.display = 'none';
                            showNotification(`تم رفع ${uploadedCount} ملف بنجاح`, 'success');
                        }, 500);
                    }
                };
                
                reader.onerror = function() {
                    showNotification(`حدث خطأ أثناء قراءة الملف ${file.name}`, 'error');
                };
                
                reader.readAsDataURL(file);
            }
        }
        
        function handleSurgeryMediaUpload(files, section) {
            if (!files || files.length === 0) return;
            
            const allowedImageTypes = ['image/jpeg', 'image/jpg', 'image/png', 'image/webp'];
            const allowedVideoTypes = ['video/mp4', 'video/webm'];
            const maxSize = 50 * 1024 * 1024;
            
            const progressContainer = document.getElementById(`${section}-progress-container`);
            const progressBar = document.getElementById(`${section}-progress-bar`);
            
            progressContainer.style.display = 'block';
            progressBar.style.width = '0%';
            progressBar.textContent = '0%';
            
            let uploadedCount = 0;
            const totalFiles = files.length;
            
            for (let i = 0; i < totalFiles; i++) {
                const file = files[i];
                const fileType = file.type;
                
                if (section === 'during') {
                    if (!allowedImageTypes.includes(fileType) && !allowedVideoTypes.includes(fileType)) {
                        showNotification(`نوع الملف ${file.name} غير مدعوم`, 'error');
                        continue;
                    }
                } else {
                    if (!allowedImageTypes.includes(fileType)) {
                        showNotification(`نوع الملف ${file.name} غير مدعوم. هذا القسم يقبل صور فقط`, 'error');
                        continue;
                    }
                }
                
                if (file.size > maxSize) {
                    showNotification(`الملف ${file.name} يتجاوز الحجم المسموح به (50MB)`, 'error');
                    continue;
                }
                
                const reader = new FileReader();
                reader.onload = function(e) {
                    const fileId = Date.now() + i;
                    const mediaType = fileType.startsWith('image/') ? 'image' : 'video';
                    
                    const mediaItem = {
                        id: fileId,
                        name: file.name,
                        size: formatFileSize(file.size),
                        type: mediaType,
                        data: e.target.result,
                        section: section
                    };
                    
                    tempSurgeryFiles[section].push(mediaItem);
                    
                    uploadedCount++;
                    const progressPercent = Math.round((uploadedCount / totalFiles) * 100);
                    progressBar.style.width = progressPercent + '%';
                    progressBar.textContent = progressPercent + '%';
                    
                    displayUploadedMedia(mediaItem, section);
                    
                    updateSectionMediaCount(section);
                    
                    if (uploadedCount === totalFiles) {
                        setTimeout(() => {
                            progressContainer.style.display = 'none';
                            showNotification(`تم رفع ${uploadedCount} ملف في قسم ${getSectionName(section)} بنجاح`, 'success');
                        }, 500);
                    }
                };
                
                reader.onerror = function() {
                    showNotification(`حدث خطأ أثناء قراءة الملف ${file.name}`, 'error');
                };
                
                reader.readAsDataURL(file);
            }
        }
        
        function getSectionName(section) {
            const sections = {
                'before': 'قبل العملية',
                'after': 'بعد العملية',
                'during': 'أثناء المتابعة'
            };
            return sections[section] || section;
        }
        
        function updateSectionMediaCount(section) {
            const count = tempSurgeryFiles[section].length;
            document.getElementById(`${section}-count`).textContent = count;
        }
        
        function displayUploadedMedia(mediaItem, type) {
            let containerId = '';
            if (type === 'patient') {
                containerId = 'patient-uploaded-media';
            } else if (['before', 'after', 'during'].includes(type)) {
                containerId = `${type}-uploaded-media`;
            } else {
                return;
            }
            
            const container = document.getElementById(containerId);
            if (!container) return;
            
            const mediaElement = document.createElement('div');
            mediaElement.className = 'uploaded-media-item';
            mediaElement.innerHTML = `
                ${mediaItem.type === 'image' ? 
                    `<img src="${mediaItem.data}" alt="${mediaItem.name}">` : 
                    `<video><source src="${mediaItem.data}" type="video/mp4"></video>`}
                <button class="uploaded-media-remove" onclick="removeUploadedMedia(${mediaItem.id}, '${type}')">
                    <i class="fas fa-times"></i>
                </button>
            `;
            
            container.appendChild(mediaElement);
        }
        
        function removeUploadedMedia(fileId, type) {
            if (type === 'patient') {
                tempPatientFiles = tempPatientFiles.filter(f => f.id !== fileId);
                document.getElementById('patient-uploaded-media').innerHTML = '';
                tempPatientFiles.forEach(item => displayUploadedMedia(item, 'patient'));
            } else if (['before', 'after', 'during'].includes(type)) {
                tempSurgeryFiles[type] = tempSurgeryFiles[type].filter(f => f.id !== fileId);
                document.getElementById(`${type}-uploaded-media`).innerHTML = '';
                tempSurgeryFiles[type].forEach(item => displayUploadedMedia(item, type));
                updateSectionMediaCount(type);
            }
            
            showNotification('تم إزالة الملف', 'info');
        }
        
        function formatFileSize(bytes) {
            if (bytes < 1024) return bytes + ' بايت';
            if (bytes < 1024 * 1024) return (bytes / 1024).toFixed(1) + ' كيلوبايت';
            return (bytes / (1024 * 1024)).toFixed(1) + ' ميجابايت';
        }
        
        function showPage(pageId) {
            document.querySelectorAll('.page').forEach(page => {
                page.classList.remove('active');
            });
            
            document.querySelectorAll('.nav-link').forEach(link => {
                link.classList.remove('active');
            });
            
            document.getElementById(pageId).classList.add('active');
            
            document.querySelector(`[data-page="${pageId}"]`).classList.add('active');
            
            if (pageId === 'patients') {
                loadPatientsTable();
                resetPatientForm();
            } else if (pageId === 'surgeries') {
                loadSurgeriesCards();
            } else if (pageId === 'files') {
                loadPatientFiles();
                updateStats();
            } else if (pageId === 'add-patient') {
                if (!editingPatientId) {
                    clearPatientForm();
                }
            }
            
            window.scrollTo(0, 0);
        }
        
        function resetPatientForm() {
            editingPatientId = null;
            patientHistory = [];
            document.getElementById('add-patient-title').innerHTML = '<i class="fas fa-user-plus"></i> إضافة مريض جديد';
            document.getElementById('patient-submit-btn').innerHTML = '<i class="fas fa-save"></i> حفظ بيانات المريض';
            document.getElementById('add-patient-back-btn').innerHTML = '<i class="fas fa-arrow-right"></i> العودة لقائمة المرضى';
            document.getElementById('add-patient-back-btn').onclick = function() {
                showPage('patients');
            };
        }
        
        function updateStats() {
            document.getElementById('total-patients').textContent = patients.length;
            document.getElementById('total-surgeries').textContent = surgeries.length;
            document.getElementById('patients-count').textContent = patients.length + ' ملف';
            document.getElementById('surgeries-count').textContent = surgeries.length + ' ملف';
            
            const today = new Date().toISOString().split('T')[0];
            const todayVisits = patients.filter(p => p.lastVisit === today).length;
            document.getElementById('today-appointments').textContent = todayVisits;
            
            let totalMedia = 0;
            patients.forEach(p => {
                if (p.mediaFiles) totalMedia += p.mediaFiles.length;
                if (p.history) {
                    p.history.forEach(h => {
                        if (h.images) totalMedia += h.images.length;
                    });
                }
            });
            surgeries.forEach(s => {
                if (s.mediaFiles) {
                    totalMedia += (s.mediaFiles.before?.length || 0);
                    totalMedia += (s.mediaFiles.after?.length || 0);
                    totalMedia += (s.mediaFiles.during?.length || 0);
                }
            });
            document.getElementById('total-media').textContent = totalMedia;
        }
        
        function loadPatientsTable(filteredPatients = null) {
            const tableBody = document.getElementById('patients-table-body');
            tableBody.innerHTML = '';
            
            const patientsToShow = filteredPatients || patients;
            
            if (patientsToShow.length === 0) {
                tableBody.innerHTML = `
                    <tr>
                        <td colspan="8" style="text-align: center; padding: 40px; color: #777;">
                            <i class="fas fa-user-slash" style="font-size: 2rem; margin-bottom: 15px; display: block;"></i>
                            لا توجد بيانات للمرضى
                        </td>
                    </tr>
                `;
                return;
            }
            
            patientsToShow.forEach((patient) => {
                const mediaCount = patient.mediaFiles ? patient.mediaFiles.length : 0;
                const historyCount = patient.history ? patient.history.length : 0;
                
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td style="text-align: center;">
                        <div class="patient-image-container">
                            ${patient.image ? 
                                `<img src="${patient.image}" alt="${patient.name}" class="patient-image" onclick="viewMediaItem('${patient.image}', 'image')">` :
                                `<div style="width: 100%; height: 100%; background-color: #e9ecef; display: flex; align-items: center; justify-content: center;">
                                    <i class="fas fa-user" style="font-size: 2rem; color: #adb5bd;"></i>
                                </div>`}
                        </div>
                    </td>
                    <td>${patient.name}</td>
                    <td>${patient.age}</td>
                    <td>${patient.phone}</td>
                    <td>${patient.diagnosis.substring(0, 30)}${patient.diagnosis.length > 30 ? '...' : ''}</td>
                    <td>
                        ${mediaCount > 0 ? 
                            `<span class="file-count" style="font-size: 0.8rem;">${mediaCount} ملف${mediaCount > 1 ? 'ات' : ''}</span>` : 
                            '<span style="color: #777; font-size: 0.9rem;">لا توجد وسائط</span>'}
                        ${historyCount > 0 ? 
                            `<br><span class="file-count" style="font-size: 0.8rem; background-color: var(--info-color); margin-top: 5px; display: inline-block;">${historyCount} سجل${historyCount > 1 ? 'ات' : ''}</span>` : ''}
                    </td>
                    <td>${formatDate(patient.lastVisit)}</td>
                    <td>
                        <div class="action-buttons">
                            <button class="action-btn view-btn" onclick="viewPatientFull(${patient.id})">
                                <i class="fas fa-eye"></i>
                            </button>
                            <button class="action-btn edit-btn" onclick="editPatient(${patient.id})">
                                <i class="fas fa-edit"></i>
                            </button>
                            <button class="action-btn delete-btn" onclick="deletePatient(${patient.id})">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    </td>
                `;
                tableBody.appendChild(row);
            });
        }
        
        function loadSurgeriesCards(filteredSurgeries = null) {
            const container = document.getElementById('surgeries-container');
            container.innerHTML = '';
            
            const surgeriesToShow = filteredSurgeries || surgeries;
            
            if (surgeriesToShow.length === 0) {
                container.innerHTML = `
                    <div style="grid-column: 1/-1; text-align: center; padding: 40px; color: #777;">
                        <i class="fas fa-procedures" style="font-size: 3rem; margin-bottom: 15px; display: block;"></i>
                        <h3>لا توجد عمليات مسجلة</h3>
                        <p>يمكنك إضافة عملية جديدة باستخدام الزر أعلاه</p>
                    </div>
                `;
                return;
            }
            
            surgeriesToShow.forEach(surgery => {
                const card = document.createElement('div');
                card.className = 'card';
                
                const beforeCount = surgery.mediaFiles?.before?.length || 0;
                const afterCount = surgery.mediaFiles?.after?.length || 0;
                const duringCount = surgery.mediaFiles?.during?.length || 0;
                const totalMedia = beforeCount + afterCount + duringCount;
                
                const firstImage = surgery.mediaFiles?.before?.[0] || 
                                  surgery.mediaFiles?.after?.[0] || 
                                  surgery.mediaFiles?.during?.[0];
                
                card.innerHTML = `
                    <div class="card-header">
                        <h3>${surgery.type}</h3>
                        <span>${formatDate(surgery.date)}</span>
                    </div>
                    <div class="card-body surgery-info">
                        ${firstImage ? `
                            <div style="text-align: center; margin-bottom: 15px;">
                                <img src="${firstImage.data}" 
                                     alt="صورة العملية" 
                                     style="width: 100%; height: 150px; object-fit: cover; border-radius: var(--border-radius); cursor: pointer;"
                                     onclick="viewMediaItem('${firstImage.data}', 'image')">
                                <small style="color: #777; display: block; margin-top: 5px;">${totalMedia} وسائط مرفقة</small>
                            </div>
                        ` : ''}
                        <p>
                            <span>اسم المريض:</span>
                            <span>${surgery.patientName}</span>
                        </p>
                        <p>
                            <span>مدة العملية:</span>
                            <span>${surgery.duration} ساعات</span>
                        </p>
                        <p>
                            <span>الجراح:</span>
                            <span>${surgery.surgeon}</span>
                        </p>
                        <p>
                            <span>التفاصيل:</span>
                            <span>${surgery.details.substring(0, 60)}${surgery.details.length > 60 ? '...' : ''}</span>
                        </p>
                        <div style="margin-top: 20px; display: flex; gap: 10px; flex-wrap: wrap;">
                            <button class="btn" onclick="viewSurgeryFull(${surgery.id})" style="padding: 8px 15px; font-size: 0.9rem;">
                                <i class="fas fa-eye"></i> التفاصيل
                            </button>
                            <button class="btn btn-warning" onclick="editSurgery(${surgery.id})" style="padding: 8px 15px; font-size: 0.9rem;">
                                <i class="fas fa-edit"></i> تعديل
                            </button>
                            <button class="btn btn-danger" onclick="deleteSurgery(${surgery.id})" style="padding: 8px 15px; font-size: 0.9rem;">
                                <i class="fas fa-trash"></i> حذف
                            </button>
                        </div>
                    </div>
                `;
                container.appendChild(card);
            });
        }
        
        function loadPatientFiles() {
            const container = document.getElementById('patient-files-container');
            container.innerHTML = '';
            
            if (patients.length === 0) {
                container.innerHTML = `
                    <div style="grid-column: 1/-1; text-align: center; padding: 40px; color: #777;">
                        <i class="fas fa-folder-open" style="font-size: 3rem; margin-bottom: 15px; display: block;"></i>
                        <h3>لا توجد ملفات للمرضى</h3>
                        <p>يمكنك إضافة مرضى جدد من خلال صفحة "إضافة مريض"</p>
                    </div>
                `;
                return;
            }
            
            patients.forEach(patient => {
                const patientSurgeries = surgeries.filter(s => s.patientId === patient.id).length;
                const mediaCount = patient.mediaFiles ? patient.mediaFiles.length : 0;
                const historyCount = patient.history ? patient.history.length : 0;
                
                const fileCard = document.createElement('div');
                fileCard.className = 'file-card';
                fileCard.innerHTML = `
                    <div class="patient-image-container">
                        ${patient.image ? 
                            `<img src="${patient.image}" alt="${patient.name}" class="patient-image" onclick="viewMediaItem('${patient.image}', 'image')">` :
                            `<div style="width: 100%; height: 100%; background-color: #e9ecef; display: flex; align-items: center; justify-content: center;">
                                <i class="fas fa-user" style="font-size: 2rem; color: #adb5bd;"></i>
                            </div>`}
                    </div>
                    <h3>${patient.name}</h3>
                    <p>${patient.diagnosis.substring(0, 40)}${patient.diagnosis.length > 40 ? '...' : ''}</p>
                    <p style="color: #777; font-size: 0.9rem; margin-top: 10px;">
                        <i class="fas fa-birthday-cake"></i> العمر: ${patient.age} سنة
                    </p>
                    <p style="color: #777; font-size: 0.9rem;">
                        <i class="fas fa-procedures"></i> العمليات: ${patientSurgeries}
                    </p>
                    <p style="color: #777; font-size: 0.9rem;">
                        <i class="fas fa-images"></i> الوسائط: ${mediaCount}
                    </p>
                    <p style="color: #777; font-size: 0.9rem;">
                        <i class="fas fa-history"></i> السجلات: ${historyCount}
                    </p>
                    <div style="margin-top: 20px;">
                        <button class="btn" onclick="viewPatientFull(${patient.id})" style="padding: 8px 20px;">
                            <i class="fas fa-folder-open"></i> فتح الملف
                        </button>
                    </div>
                `;
                container.appendChild(fileCard);
            });
        }
        
        function addNewPatient() {
            const name = document.getElementById('patient-name').value;
            const age = document.getElementById('patient-age').value;
            const phone = document.getElementById('patient-phone').value;
            const gender = document.getElementById('patient-gender').value;
            const bloodType = document.getElementById('patient-blood-type').value;
            const address = document.getElementById('patient-address').value;
            const diagnosis = document.getElementById('patient-diagnosis').value;
            const notes = document.getElementById('patient-notes').value;
            const registrationDate = document.getElementById('patient-date').value;
            
            if (!name || !age || !phone || !diagnosis) {
                showNotification('يرجى ملء جميع الحقول الإلزامية', 'error');
                return;
            }
            
            const mediaFiles = [...tempPatientFiles];
            
            const newPatient = {
                id: patients.length > 0 ? Math.max(...patients.map(p => p.id)) + 1 : 1,
                name,
                age: parseInt(age),
                phone,
                gender,
                bloodType,
                address,
                diagnosis,
                notes,
                registrationDate,
                lastVisit: registrationDate,
                image: tempPatientFiles[0]?.data || '',
                mediaFiles: mediaFiles,
                history: [...patientHistory]
            };
            
            patients.push(newPatient);
            saveData();
            
            clearPatientForm();
            showNotification('تم إضافة المريض بنجاح', 'success');
            updateStats();
            showPage('patients');
        }
        
        function editPatient(patientId) {
            const patient = patients.find(p => p.id === patientId);
            if (!patient) return;
            
            editingPatientId = patientId;
            showPage('add-patient');
            
            document.getElementById('patient-name').value = patient.name;
            document.getElementById('patient-age').value = patient.age;
            document.getElementById('patient-phone').value = patient.phone;
            document.getElementById('patient-gender').value = patient.gender;
            document.getElementById('patient-blood-type').value = patient.bloodType;
            document.getElementById('patient-address').value = patient.address || '';
            document.getElementById('patient-diagnosis').value = patient.diagnosis;
            document.getElementById('patient-notes').value = patient.notes || '';
            document.getElementById('patient-date').value = patient.registrationDate;
            
            if (patient.image) {
                document.getElementById('patient-image-preview').src = patient.image;
            }
            
            tempPatientFiles = patient.mediaFiles ? [...patient.mediaFiles] : [];
            patientHistory = patient.history ? [...patient.history] : [];
            
            const uploadedContainer = document.getElementById('patient-uploaded-media');
            uploadedContainer.innerHTML = '';
            tempPatientFiles.forEach(item => displayUploadedMedia(item, 'patient'));
            
            renderHistoryItems();
            
            document.getElementById('add-patient-title').innerHTML = '<i class="fas fa-user-edit"></i> تعديل بيانات المريض';
            document.getElementById('patient-submit-btn').innerHTML = '<i class="fas fa-save"></i> تحديث بيانات المريض';
            document.getElementById('add-patient-back-btn').innerHTML = '<i class="fas fa-times"></i> إلغاء التعديل';
            document.getElementById('add-patient-back-btn').onclick = function() {
                clearPatientForm();
                resetPatientForm();
                showPage('patients');
            };
        }
        
        function updatePatient(patientId) {
            const name = document.getElementById('patient-name').value;
            const age = document.getElementById('patient-age').value;
            const phone = document.getElementById('patient-phone').value;
            const gender = document.getElementById('patient-gender').value;
            const bloodType = document.getElementById('patient-blood-type').value;
            const address = document.getElementById('patient-address').value;
            const diagnosis = document.getElementById('patient-diagnosis').value;
            const notes = document.getElementById('patient-notes').value;
            const registrationDate = document.getElementById('patient-date').value;
            
            if (!name || !age || !phone || !diagnosis) {
                showNotification('يرجى ملء جميع الحقول الإلزامية', 'error');
                return;
            }
            
            const mediaFiles = [...tempPatientFiles];
            
            const index = patients.findIndex(p => p.id === patientId);
            if (index !== -1) {
                patients[index] = {
                    ...patients[index],
                    name,
                    age: parseInt(age),
                    phone,
                    gender,
                    bloodType,
                    address,
                    diagnosis,
                    notes,
                    registrationDate,
                    image: tempPatientFiles[0]?.data || patients[index].image,
                    mediaFiles: mediaFiles,
                    history: [...patientHistory]
                };
                
                saveData();
                clearPatientForm();
                resetPatientForm();
                showNotification('تم تحديث بيانات المريض بنجاح', 'success');
                showPage('patients');
            }
        }
        
        function clearPatientForm() {
            document.getElementById('add-patient-form').reset();
            document.getElementById('patient-date').value = new Date().toISOString().split('T')[0];
            document.getElementById('patient-image-preview').src = '';
            tempPatientFiles = [];
            patientHistory = [];
            document.getElementById('patient-uploaded-media').innerHTML = '';
            document.getElementById('patient-progress-container').style.display = 'none';
            renderHistoryItems();
        }
        
        function showAddSurgeryForm() {
            document.getElementById('surgery-modal-title').textContent = 'إضافة عملية جراحية جديدة';
            document.getElementById('surgery-submit-btn').innerHTML = '<i class="fas fa-save"></i> حفظ العملية';
            document.getElementById('surgery-form').reset();
            document.getElementById('surgery-id').value = '';
            document.getElementById('modal-surgery-date').value = new Date().toISOString().split('T')[0];
            document.getElementById('modal-surgery-patient').value = '';
            document.getElementById('modal-surgery-patient-id').value = '';
            
            tempSurgeryFiles = {
                before: [],
                after: [],
                during: []
            };
            
            document.getElementById('before-uploaded-media').innerHTML = '';
            document.getElementById('after-uploaded-media').innerHTML = '';
            document.getElementById('during-uploaded-media').innerHTML = '';
            
            updateSectionMediaCount('before');
            updateSectionMediaCount('after');
            updateSectionMediaCount('during');
            
            document.querySelectorAll('.tab').forEach((tab, index) => {
                if (index === 0) {
                    tab.classList.add('active');
                } else {
                    tab.classList.remove('active');
                }
            });
            
            document.querySelectorAll('.tab-content').forEach((content, index) => {
                if (index === 0) {
                    content.classList.add('active');
                } else {
                    content.classList.remove('active');
                }
            });
            
            document.getElementById('patient-autocomplete-dropdown').style.display = 'none';
            
            document.getElementById('surgery-modal').style.display = 'flex';
        }
        
        function editSurgery(surgeryId) {
            const surgery = surgeries.find(s => s.id === surgeryId);
            if (!surgery) return;
            
            document.getElementById('surgery-modal-title').textContent = 'تعديل عملية جراحية';
            document.getElementById('surgery-submit-btn').innerHTML = '<i class="fas fa-save"></i> حفظ التعديلات';
            
            document.getElementById('surgery-id').value = surgery.id;
            document.getElementById('modal-surgery-patient').value = surgery.patientName;
            document.getElementById('modal-surgery-patient-id').value = surgery.patientId;
            document.getElementById('modal-surgery-type').value = surgery.type;
            document.getElementById('modal-surgery-date').value = surgery.date;
            document.getElementById('modal-surgery-duration').value = surgery.duration;
            document.getElementById('modal-surgery-details').value = surgery.details;
            document.getElementById('modal-surgery-surgeon').value = surgery.surgeon;
            document.getElementById('modal-surgery-notes').value = surgery.notes || '';
            
            tempSurgeryFiles = surgery.mediaFiles || {
                before: [],
                after: [],
                during: []
            };
            
            document.getElementById('before-uploaded-media').innerHTML = '';
            document.getElementById('after-uploaded-media').innerHTML = '';
            document.getElementById('during-uploaded-media').innerHTML = '';
            
            tempSurgeryFiles.before.forEach(item => displayUploadedMedia(item, 'before'));
            tempSurgeryFiles.after.forEach(item => displayUploadedMedia(item, 'after'));
            tempSurgeryFiles.during.forEach(item => displayUploadedMedia(item, 'during'));
            
            updateSectionMediaCount('before');
            updateSectionMediaCount('after');
            updateSectionMediaCount('during');
            
            document.getElementById('patient-autocomplete-dropdown').style.display = 'none';
            
            document.getElementById('surgery-modal').style.display = 'flex';
        }
        
        function closeSurgeryModal() {
            document.getElementById('surgery-modal').style.display = 'none';
        }
        
        function saveSurgery() {
            const surgeryId = document.getElementById('surgery-id').value;
            const patientName = document.getElementById('modal-surgery-patient').value;
            const patientId = document.getElementById('modal-surgery-patient-id').value;
            const type = document.getElementById('modal-surgery-type').value;
            const date = document.getElementById('modal-surgery-date').value;
            const duration = parseFloat(document.getElementById('modal-surgery-duration').value) || 0;
            const details = document.getElementById('modal-surgery-details').value;
            const surgeon = document.getElementById('modal-surgery-surgeon').value;
            const notes = document.getElementById('modal-surgery-notes').value;
            
            if (!patientName || !patientId || !type || !date || !details) {
                showNotification('يرجى ملء جميع الحقول الإلزامية وتحديد المريض', 'error');
                return;
            }
            
            const patient = patients.find(p => p.id === parseInt(patientId));
            if (!patient) {
                showNotification('المريض المحدد غير موجود', 'error');
                return;
            }
            
            if (surgeryId) {
                const index = surgeries.findIndex(s => s.id === parseInt(surgeryId));
                if (index !== -1) {
                    surgeries[index] = {
                        ...surgeries[index],
                        patientId: parseInt(patientId),
                        patientName: patient.name,
                        type,
                        date,
                        duration,
                        details,
                        surgeon,
                        notes,
                        mediaFiles: {
                            before: [...tempSurgeryFiles.before],
                            after: [...tempSurgeryFiles.after],
                            during: [...tempSurgeryFiles.during]
                        }
                    };
                    
                    showNotification('تم تعديل العملية بنجاح', 'success');
                }
            } else {
                const newSurgery = {
                    id: surgeries.length > 0 ? Math.max(...surgeries.map(s => s.id)) + 1 : 1,
                    patientId: parseInt(patientId),
                    patientName: patient.name,
                    type,
                    date,
                    duration,
                    details,
                    surgeon,
                    notes,
                    mediaFiles: {
                        before: [...tempSurgeryFiles.before],
                        after: [...tempSurgeryFiles.after],
                        during: [...tempSurgeryFiles.during]
                    }
                };
                
                surgeries.push(newSurgery);
                showNotification('تم إضافة العملية الجراحية بنجاح', 'success');
            }
            
            saveData();
            
            patient.lastVisit = date;
            saveData();
            
            closeSurgeryModal();
            updateStats();
            loadSurgeriesCards();
        }
        
        function viewPatientFull(patientId) {
            const patient = patients.find(p => p.id === patientId);
            if (!patient) return;
            
            const patientSurgeries = surgeries.filter(s => s.patientId === patientId);
            const mediaCount = patient.mediaFiles ? patient.mediaFiles.length : 0;
            const historyCount = patient.history ? patient.history.length : 0;
            
            document.getElementById('patient-full-modal-title').textContent = `ملف المريض: ${patient.name}`;
            
            let mediaHTML = '';
            if (mediaCount > 0) {
                const mediaItems = patient.mediaFiles.slice(0, 12).map(media => `
                    <div class="album-item" onclick="viewMediaItem('${media.data}', '${media.type}')">
                        ${media.type === 'image' ? 
                            `<img src="${media.data}" alt="${media.name}">` : 
                            `<video><source src="${media.data}" type="video/mp4"></video>`}
                        <div class="album-item-date">
                            ${media.name.substring(0, 20)}${media.name.length > 20 ? '...' : ''}
                        </div>
                    </div>
                `).join('');
                
                mediaHTML = `
                    <div class="patient-album">
                        <div class="album-controls">
                            <h4 class="section-title">ألبوم الوسائط (${mediaCount} ملف)</h4>
                            ${mediaCount > 0 ? `
                                <button class="btn btn-info" onclick="openMediaGallery(${patientId}, 'patient')">
                                    <i class="fas fa-images"></i> عرض جميع الوسائط
                                </button>
                            ` : ''}
                        </div>
                        <div class="album-grid">
                            ${mediaItems}
                            ${mediaCount > 12 ? `
                                <div class="album-item" style="display: flex; align-items: center; justify-content: center; background-color: var(--primary-color); cursor: pointer;" onclick="openMediaGallery(${patientId}, 'patient')">
                                    <div style="text-align: center; color: white;">
                                        <i class="fas fa-plus" style="font-size: 2rem;"></i>
                                        <p>عرض ${mediaCount - 12} ملف إضافي</p>
                                    </div>
                                </div>
                            ` : ''}
                        </div>
                    </div>
                `;
            } else {
                mediaHTML = `
                    <div style="text-align: center; padding: 40px; color: #777;">
                        <i class="fas fa-images" style="font-size: 3rem; margin-bottom: 15px;"></i>
                        <h4>لا توجد وسائط للمريض</h4>
                    </div>
                `;
            }
            
            let historyHTML = '';
            if (historyCount > 0) {
                historyHTML = `
                    <div class="section-title">السجلات التاريخية (${historyCount} سجل)</div>
                    <div class="cards-container">
                        ${patient.history.map((historyItem, index) => {
                            const imageCount = historyItem.images ? historyItem.images.length : 0;
                            return `
                                <div class="card">
                                    <div class="card-header">
                                        <h3>السجل ${index + 1}</h3>
                                        <span>${formatDate(historyItem.date)}</span>
                                    </div>
                                    <div class="card-body">
                                        <p><strong>الملاحظات:</strong></p>
                                        <p>${historyItem.notes || 'لا توجد ملاحظات'}</p>
                                        <p><strong>الصور المرفقة:</strong> ${imageCount}</p>
                                        ${imageCount > 0 ? `
                                            <div style="margin-top: 15px;">
                                                <button class="btn btn-info" onclick="viewHistoryImages(${patientId}, ${index})">
                                                    <i class="fas fa-eye"></i> عرض الصور
                                                </button>
                                            </div>
                                        ` : ''}
                                    </div>
                                </div>
                            `;
                        }).join('')}
                    </div>
                `;
            } else {
                historyHTML = `
                    <div style="text-align: center; padding: 20px; color: #777;">
                        <i class="fas fa-history" style="font-size: 2rem; margin-bottom: 10px;"></i>
                        <p>لا توجد سجلات تاريخية</p>
                    </div>
                `;
            }
            
            let surgeriesHTML = '';
            if (patientSurgeries.length > 0) {
                surgeriesHTML = `
                    <div class="section-title">العمليات الجراحية (${patientSurgeries.length})</div>
                    <div class="cards-container">
                        ${patientSurgeries.map(surgery => {
                            const beforeCount = surgery.mediaFiles?.before?.length || 0;
                            const afterCount = surgery.mediaFiles?.after?.length || 0;
                            const duringCount = surgery.mediaFiles?.during?.length || 0;
                            const totalMedia = beforeCount + afterCount + duringCount;
                            
                            return `
                                <div class="card">
                                    <div class="card-header">
                                        <h3>${surgery.type}</h3>
                                        <span>${formatDate(surgery.date)}</span>
                                    </div>
                                    <div class="card-body">
                                        <p><strong>المدة:</strong> ${surgery.duration} ساعات</p>
                                        <p><strong>التفاصيل:</strong> ${surgery.details.substring(0, 80)}${surgery.details.length > 80 ? '...' : ''}</p>
                                        <p><strong>الوسائط:</strong> ${totalMedia} ملف</p>
                                        <div style="margin-top: 15px;">
                                            <button class="btn" onclick="viewSurgeryFull(${surgery.id})">
                                                <i class="fas fa-eye"></i> عرض التفاصيل
                                            </button>
                                            <button class="btn btn-warning" onclick="editSurgery(${surgery.id})" style="margin-right: 10px;">
                                                <i class="fas fa-edit"></i> تعديل
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            `;
                        }).join('')}
                    </div>
                `;
            } else {
                surgeriesHTML = `
                    <div style="text-align: center; padding: 20px; color: #777;">
                        <i class="fas fa-procedures" style="font-size: 2rem; margin-bottom: 10px;"></i>
                        <p>لا توجد عمليات مسجلة لهذا المريض</p>
                    </div>
                `;
            }
            
            const contentHTML = `
                <div class="patient-full-view">
                    <div class="patient-header">
                        <div class="patient-avatar">
                            ${patient.image ? 
                                `<img src="${patient.image}" alt="${patient.name}">` :
                                `<div style="width: 100%; height: 100%; background-color: #e9ecef; display: flex; align-items: center; justify-content: center;">
                                    <i class="fas fa-user" style="font-size: 3rem; color: #adb5bd;"></i>
                                </div>`}
                        </div>
                        <div class="patient-details">
                            <h3>${patient.name}</h3>
                            <div class="patient-meta">
                                <div class="meta-item">
                                    <div class="meta-label">العمر</div>
                                    <div class="meta-value">${patient.age} سنة</div>
                                </div>
                                <div class="meta-item">
                                    <div class="meta-label">الجنس</div>
                                    <div class="meta-value">${patient.gender}</div>
                                </div>
                                <div class="meta-item">
                                    <div class="meta-label">فصيلة الدم</div>
                                    <div class="meta-value">${patient.bloodType}</div>
                                </div>
                                <div class="meta-item">
                                    <div class="meta-label">الهاتف</div>
                                    <div class="meta-value">${patient.phone}</div>
                                </div>
                                <div class="meta-item">
                                    <div class="meta-label">تاريخ التسجيل</div>
                                    <div class="meta-value">${formatDate(patient.registrationDate)}</div>
                                </div>
                                <div class="meta-item">
                                    <div class="meta-label">آخر زيارة</div>
                                    <div class="meta-value">${formatDate(patient.lastVisit)}</div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="section-title">التشخيص</div>
                    <div style="background-color: #f8f9fa; padding: 20px; border-radius: var(--border-radius); margin-bottom: 30px;">
                        <p>${patient.diagnosis}</p>
                        ${patient.notes ? `<p><strong>ملاحظات إضافية:</strong> ${patient.notes}</p>` : ''}
                    </div>
                    
                    <div class="section-title">العنوان</div>
                    <div style="background-color: #f8f9fa; padding: 15px; border-radius: var(--border-radius); margin-bottom: 30px;">
                        <p>${patient.address || 'لم يتم تسجيل عنوان'}</p>
                    </div>
                    
                    ${historyHTML}
                    
                    ${mediaHTML}
                    
                    ${surgeriesHTML}
                    
                    <div style="margin-top: 30px; text-align: center;">
                        <button class="btn btn-primary" onclick="editPatient(${patient.id}); closePatientFullModal()" style="padding: 12px 30px; margin-left: 15px;">
                            <i class="fas fa-edit"></i> تعديل بيانات المريض
                        </button>
                        <button class="btn btn-danger" onclick="deletePatient(${patient.id}); closePatientFullModal()" style="padding: 12px 30px;">
                            <i class="fas fa-trash"></i> حذف المريض
                        </button>
                    </div>
                </div>
            `;
            
            document.getElementById('patient-full-content').innerHTML = contentHTML;
            document.getElementById('patient-full-modal').style.display = 'flex';
        }
        
        function viewHistoryImages(patientId, historyIndex) {
            const patient = patients.find(p => p.id === patientId);
            if (!patient || !patient.history || !patient.history[historyIndex]) return;
            
            const historyItem = patient.history[historyIndex];
            if (!historyItem.images || historyItem.images.length === 0) return;
            
            const mediaItems = historyItem.images.map(img => ({
                data: img.data,
                type: 'image',
                name: img.name
            }));
            
            if (mediaItems.length > 0) {
                currentMediaPreview.items = mediaItems;
                currentMediaPreview.currentIndex = 0;
                showMediaPreview();
            }
        }
        
        function closePatientFullModal() {
            document.getElementById('patient-full-modal').style.display = 'none';
        }
        
        function viewSurgeryFull(surgeryId) {
            const surgery = surgeries.find(s => s.id === surgeryId);
            if (!surgery) return;
            
            const beforeCount = surgery.mediaFiles?.before?.length || 0;
            const afterCount = surgery.mediaFiles?.after?.length || 0;
            const duringCount = surgery.mediaFiles?.during?.length || 0;
            const totalMedia = beforeCount + afterCount + duringCount;
            
            let mediaHTML = '';
            
            if (totalMedia > 0) {
                mediaHTML = `
                    <div class="surgery-media-sections">
                        ${beforeCount > 0 ? `
                            <div class="media-section">
                                <h4><i class="fas fa-camera"></i> صور قبل العملية <span class="section-media-count">${beforeCount}</span></h4>
                                <div class="album-grid">
                                    ${surgery.mediaFiles.before.slice(0, 6).map(media => `
                                        <div class="album-item" onclick="viewMediaItem('${media.data}', '${media.type}')">
                                            <img src="${media.data}" alt="${media.name}">
                                            <div class="album-item-date">
                                                ${media.name.substring(0, 20)}${media.name.length > 20 ? '...' : ''}
                                            </div>
                                        </div>
                                    `).join('')}
                                    ${beforeCount > 6 ? `
                                        <div class="album-item" style="display: flex; align-items: center; justify-content: center; background-color: var(--primary-color); cursor: pointer;" onclick="openSurgeryMediaGallery(${surgeryId}, 'before')">
                                            <div style="text-align: center; color: white;">
                                                <i class="fas fa-plus" style="font-size: 2rem;"></i>
                                                <p>عرض ${beforeCount - 6} ملف إضافي</p>
                                            </div>
                                        </div>
                                    ` : ''}
                                </div>
                            </div>
                        ` : ''}
                        
                        ${afterCount > 0 ? `
                            <div class="media-section">
                                <h4><i class="fas fa-camera"></i> صور بعد العملية <span class="section-media-count">${afterCount}</span></h4>
                                <div class="album-grid">
                                    ${surgery.mediaFiles.after.slice(0, 6).map(media => `
                                        <div class="album-item" onclick="viewMediaItem('${media.data}', '${media.type}')">
                                            <img src="${media.data}" alt="${media.name}">
                                            <div class="album-item-date">
                                                ${media.name.substring(0, 20)}${media.name.length > 20 ? '...' : ''}
                                            </div>
                                        </div>
                                    `).join('')}
                                    ${afterCount > 6 ? `
                                        <div class="album-item" style="display: flex; align-items: center; justify-content: center; background-color: var(--primary-color); cursor: pointer;" onclick="openSurgeryMediaGallery(${surgeryId}, 'after')">
                                            <div style="text-align: center; color: white;">
                                                <i class="fas fa-plus" style="font-size: 2rem;"></i>
                                                <p>عرض ${afterCount - 6} ملف إضافي</p>
                                            </div>
                                        </div>
                                    ` : ''}
                                </div>
                            </div>
                        ` : ''}
                        
                        ${duringCount > 0 ? `
                            <div class="media-section">
                                <h4><i class="fas fa-camera"></i> صور أثناء المتابعة <span class="section-media-count">${duringCount}</span></h4>
                                <div class="album-grid">
                                    ${surgery.mediaFiles.during.slice(0, 6).map(media => `
                                        <div class="album-item" onclick="viewMediaItem('${media.data}', '${media.type}')">
                                            ${media.type === 'image' ? 
                                                `<img src="${media.data}" alt="${media.name}">` : 
                                                `<video><source src="${media.data}" type="video/mp4"></video>`}
                                            <div class="album-item-date">
                                                ${media.name.substring(0, 20)}${media.name.length > 20 ? '...' : ''}
                                            </div>
                                        </div>
                                    `).join('')}
                                    ${duringCount > 6 ? `
                                        <div class="album-item" style="display: flex; align-items: center; justify-content: center; background-color: var(--primary-color); cursor: pointer;" onclick="openSurgeryMediaGallery(${surgeryId}, 'during')">
                                            <div style="text-align: center; color: white;">
                                                <i class="fas fa-plus" style="font-size: 2rem;"></i>
                                                <p>عرض ${duringCount - 6} ملف إضافي</p>
                                            </div>
                                        </div>
                                    ` : ''}
                                </div>
                            </div>
                        ` : ''}
                    </div>
                `;
            } else {
                mediaHTML = `
                    <div style="text-align: center; padding: 20px; color: #777;">
                        <i class="fas fa-images" style="font-size: 2rem; margin-bottom: 10px;"></i>
                        <p>لا توجد وسائط للعملية</p>
                    </div>
                `;
            }
            
            const modalContent = `
                <div class="modal-overlay">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h3>تفاصيل العملية: ${surgery.type}</h3>
                            <button class="modal-close" onclick="this.parentElement.parentElement.parentElement.remove()">&times;</button>
                        </div>
                        
                        <div class="patient-full-view">
                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 25px;">
                                <div>
                                    <h4 style="color: var(--primary-color); margin-bottom: 15px;">معلومات العملية</h4>
                                    <p><strong>اسم المريض:</strong> ${surgery.patientName}</p>
                                    <p><strong>نوع العملية:</strong> ${surgery.type}</p>
                                    <p><strong>تاريخ العملية:</strong> ${formatDate(surgery.date)}</p>
                                    <p><strong>مدة العملية:</strong> ${surgery.duration} ساعات</p>
                                    <p><strong>الجراح:</strong> ${surgery.surgeon}</p>
                                </div>
                                <div>
                                    <h4 style="color: var(--primary-color); margin-bottom: 15px;">تفاصيل إضافية</h4>
                                    <p><strong>التفاصيل:</strong></p>
                                    <p>${surgery.details}</p>
                                    <p><strong>ملاحظات:</strong> ${surgery.notes || 'لا توجد ملاحظات'}</p>
                                </div>
                            </div>
                            
                            ${mediaHTML}
                            
                            <div style="text-align: center; margin-top: 30px; display: flex; gap: 15px; justify-content: center;">
                                <button class="btn btn-warning" onclick="editSurgery(${surgeryId}); this.parentElement.parentElement.parentElement.parentElement.remove()">
                                    <i class="fas fa-edit"></i> تعديل العملية
                                </button>
                                <button class="btn btn-danger" onclick="deleteSurgery(${surgeryId}); this.parentElement.parentElement.parentElement.parentElement.remove()">
                                    <i class="fas fa-trash"></i> حذف العملية
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            
            const modalDiv = document.createElement('div');
            modalDiv.innerHTML = modalContent;
            document.body.appendChild(modalDiv);
        }
        
        function openSurgeryMediaGallery(surgeryId, section) {
            const surgery = surgeries.find(s => s.id === surgeryId);
            if (!surgery || !surgery.mediaFiles || !surgery.mediaFiles[section]) return;
            
            const mediaItems = surgery.mediaFiles[section].map(m => ({
                data: m.data,
                type: m.type,
                name: m.name
            }));
            
            if (mediaItems.length > 0) {
                currentMediaPreview.items = mediaItems;
                currentMediaPreview.currentIndex = 0;
                showMediaPreview();
            }
        }
        
        function deletePatient(patientId) {
            if (confirm('هل أنت متأكد من حذف هذا المريض؟ سيتم حذف جميع العمليات المرتبطة به أيضاً.')) {
                patients = patients.filter(p => p.id !== patientId);
                surgeries = surgeries.filter(s => s.patientId !== patientId);
                saveData();
                loadPatientsTable();
                updateStats();
                showNotification('تم حذف المريض بنجاح', 'success');
            }
        }
        
        function deleteSurgery(surgeryId) {
            if (confirm('هل أنت متأكد من حذف هذه العملية؟')) {
                surgeries = surgeries.filter(s => s.id !== surgeryId);
                saveData();
                loadSurgeriesCards();
                updateStats();
                showNotification('تم حذف العملية بنجاح', 'success');
            }
        }
        
        function changeDoctorImage() {
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = 'image/jpeg,image/jpg,image/png,image/webp';
            
            input.onchange = function(e) {
                if (e.target.files && e.target.files[0]) {
                    handleImageUpload(e.target.files[0], 'doctor');
                }
            };
            
            input.click();
        }
        
        function viewMediaItem(data, type) {
            currentMediaPreview.items = [{data, type}];
            currentMediaPreview.currentIndex = 0;
            showMediaPreview();
        }
        
        function openMediaGallery(patientId, type) {
            let mediaItems = [];
            
            if (type === 'patient' && patientId) {
                const patient = patients.find(p => p.id === patientId);
                if (patient && patient.mediaFiles) {
                    mediaItems = patient.mediaFiles.map(m => ({data: m.data, type: m.type, name: m.name}));
                }
            }
            
            if (mediaItems.length > 0) {
                currentMediaPreview.items = mediaItems;
                currentMediaPreview.currentIndex = 0;
                showMediaPreview();
            }
        }
        
        function showMediaPreview() {
            if (currentMediaPreview.items.length === 0) return;
            
            const previewContent = document.querySelector('.media-preview-content');
            const currentItem = currentMediaPreview.items[currentMediaPreview.currentIndex];
            
            let mediaElement = '';
            if (currentItem.type === 'image') {
                mediaElement = `<img src="${currentItem.data}" alt="معاينة الصورة">`;
            } else if (currentItem.type === 'video') {
                mediaElement = `<video controls autoplay><source src="${currentItem.data}" type="video/mp4">متصفحك لا يدعم تشغيل الفيديو</video>`;
            }
            
            previewContent.innerHTML = mediaElement;
            document.getElementById('media-counter').textContent = `${currentMediaPreview.currentIndex + 1} / ${currentMediaPreview.items.length}`;
            document.getElementById('media-preview-modal').style.display = 'flex';
        }
        
        function navigateMedia(direction) {
            if (currentMediaPreview.items.length === 0) return;
            
            currentMediaPreview.currentIndex += direction;
            
            if (currentMediaPreview.currentIndex < 0) {
                currentMediaPreview.currentIndex = currentMediaPreview.items.length - 1;
            } else if (currentMediaPreview.currentIndex >= currentMediaPreview.items.length) {
                currentMediaPreview.currentIndex = 0;
            }
            
            showMediaPreview();
        }
        
        function closeMediaPreview() {
            document.getElementById('media-preview-modal').style.display = 'none';
            currentMediaPreview.items = [];
            currentMediaPreview.currentIndex = 0;
        }
        
        function formatDate(dateString) {
            if (!dateString) return 'غير محدد';
            try {
                const date = new Date(dateString);
                return date.toLocaleDateString('ar-EG');
            } catch (error) {
                return dateString;
            }
        }
        
        function showNotification(message, type) {
            const notification = document.getElementById('notification');
            notification.textContent = message;
            notification.className = `notification ${type}-notification`;
            notification.style.display = 'block';
            
            setTimeout(() => {
                notification.style.display = 'none';
            }, 3000);
        }
        // استبدل الدالة addNewHistoryItem بهذه الدالة
function addNewHistoryItem() {
    const historyId = Date.now();
    
    const historyFormHTML = `
        <div class="history-form" data-history-id="${historyId}">
            <h4 style="color: var(--primary-color); margin-bottom: 15px;">
                <i class="fas fa-plus"></i> إضافة سجل تاريخي جديد
            </h4>
            
            <div class="form-row">
                <div class="form-group">
                    <label>التاريخ *</label>
                    <input type="date" id="history-date-${historyId}" class="form-control" value="${new Date().toISOString().split('T')[0]}">
                </div>
            </div>
            
            <div class="form-group">
                <label>ملاحظات *</label>
                <textarea id="history-notes-${historyId}" class="form-control" rows="3" placeholder="أدخل الملاحظات..." required></textarea>
            </div>
            
            <div class="form-group">
                <label>صور إضافية (4 صور كحد أقصى)</label>
                <div class="history-images" id="history-images-preview-${historyId}">
                    <!-- سيتم عرض معاينة الصور هنا -->
                </div>
                <div style="margin-top: 15px;">
                    <label for="history-image-upload-${historyId}" class="upload-label" style="display: inline-block;">
                        <i class="fas fa-camera"></i> اختيار صور
                    </label>
                    <input type="file" id="history-image-upload-${historyId}" class="upload-input" accept="image/jpeg,image/jpg,image/png,image/webp" multiple onchange="previewHistoryImages(${historyId}, this.files)">
                    <small style="display: block; color: #777; margin-top: 5px;">يمكنك إضافة حتى 4 صور</small>
                </div>
            </div>
            
            <div class="form-group" id="history-selected-files-${historyId}" style="display: none;">
                <label>الملفات المحددة:</label>
                <div class="file-list" id="history-files-list-${historyId}">
                </div>
            </div>
            
            <div style="display: flex; gap: 15px; justify-content: center; margin-top: 20px;">
                <button type="button" class="btn btn-primary" onclick="saveHistoryItem(${historyId})">
                    <i class="fas fa-save"></i> حفظ السجل
                </button>
                <button type="button" class="btn btn-danger" onclick="cancelHistoryItem(${historyId})">
                    <i class="fas fa-times"></i> إلغاء
                </button>
            </div>
        </div>
    `;
    
    const container = document.getElementById('history-items-container');
    container.insertAdjacentHTML('beforeend', historyFormHTML);
}

// دالة جديدة لمعاينة الصور قبل الحفظ
function previewHistoryImages(historyId, files) {
    const filesList = document.getElementById(`history-files-list-${historyId}`);
    const previewContainer = document.getElementById(`history-images-preview-${historyId}`);
    const selectedFilesContainer = document.getElementById(`history-selected-files-${historyId}`);
    
    if (!files || files.length === 0) return;
    
    const allowedTypes = ['image/jpeg', 'image/jpg', 'image/png', 'image/webp'];
    const maxFiles = 4;
    const maxSize = 5 * 1024 * 1024; // 5MB
    
    // مسح القوائم السابقة
    filesList.innerHTML = '';
    previewContainer.innerHTML = '';
    
    let validFiles = [];
    
    for (let i = 0; i < Math.min(files.length, maxFiles); i++) {
        const file = files[i];
        
        if (!allowedTypes.includes(file.type)) {
            showNotification(`نوع الملف ${file.name} غير مدعوم`, 'error');
            continue;
        }
        
        if (file.size > maxSize) {
            showNotification(`الملف ${file.name} يتجاوز الحجم المسموح به (5MB)`, 'error');
            continue;
        }
        
        validFiles.push(file);
        
        // إضافة إلى قائمة الملفات
        const fileItem = document.createElement('div');
        fileItem.className = 'file-item';
        fileItem.innerHTML = `
            <div class="file-name">${file.name}</div>
            <div class="file-size">${formatFileSize(file.size)}</div>
            <button type="button" class="file-remove" onclick="removeHistoryFile(${historyId}, ${i})">
                <i class="fas fa-times"></i>
            </button>
        `;
        filesList.appendChild(fileItem);
        
        // معاينة الصورة
        const reader = new FileReader();
        reader.onload = function(e) {
            const imgPreview = document.createElement('div');
            imgPreview.className = 'history-image-container';
            imgPreview.innerHTML = `
                <img src="${e.target.result}" alt="${file.name}">
                <button type="button" class="history-image-remove" onclick="removeHistoryFile(${historyId}, ${i})">
                    <i class="fas fa-times"></i>
                </button>
            `;
            previewContainer.appendChild(imgPreview);
        };
        reader.readAsDataURL(file);
    }
    
    // تخزين الملفات مؤقتًا
    if (!window.tempHistoryFiles) {
        window.tempHistoryFiles = {};
    }
    window.tempHistoryFiles[historyId] = validFiles;
    
    if (validFiles.length > 0) {
        selectedFilesContainer.style.display = 'block';
    }
}

// دالة لحذف ملف من القائمة المؤقتة
function removeHistoryFile(historyId, fileIndex) {
    if (window.tempHistoryFiles && window.tempHistoryFiles[historyId]) {
        window.tempHistoryFiles[historyId].splice(fileIndex, 1);
        previewHistoryImages(historyId, window.tempHistoryFiles[historyId]);
    }
}

// دالة لحفظ السجل التاريخي
function saveHistoryItem(historyId) {
    const dateInput = document.getElementById(`history-date-${historyId}`);
    const notesInput = document.getElementById(`history-notes-${historyId}`);
    
    const date = dateInput.value;
    const notes = notesInput.value;
    
    if (!date || !notes.trim()) {
        showNotification('يرجى إدخال التاريخ والملاحظات', 'error');
        return;
    }
    
    const historyItem = {
        id: historyId,
        date: date,
        notes: notes,
        images: []
    };
    
    // معالجة الصور إذا كانت موجودة
    if (window.tempHistoryFiles && window.tempHistoryFiles[historyId]) {
        const files = window.tempHistoryFiles[historyId];
        
        if (files.length > 0) {
            // تحويل الملفات إلى base64
            let processedCount = 0;
            const totalFiles = files.length;
            
            files.forEach((file, index) => {
                const reader = new FileReader();
                reader.onload = function(e) {
                    historyItem.images.push({
                        id: Date.now() + index,
                        name: file.name,
                        data: e.target.result
                    });
                    
                    processedCount++;
                    
                    if (processedCount === totalFiles) {
                        // إضافة السجل بعد معالجة جميع الصور
                        patientHistory.push(historyItem);
                        renderHistoryItems();
                        showNotification('تم حفظ السجل التاريخي بنجاح', 'success');
                    }
                };
                reader.readAsDataURL(file);
            });
        } else {
            // لا توجد صور
            patientHistory.push(historyItem);
            renderHistoryItems();
            showNotification('تم حفظ السجل التاريخي بنجاح', 'success');
        }
    } else {
        // لا توجد صور
        patientHistory.push(historyItem);
        renderHistoryItems();
        showNotification('تم حفظ السجل التاريخي بنجاح', 'success');
    }
    
    // تنظيف الملفات المؤقتة
    if (window.tempHistoryFiles) {
        delete window.tempHistoryFiles[historyId];
    }
}

// دالة لإلغاء إضافة السجل
function cancelHistoryItem(historyId) {
    const form = document.querySelector(`[data-history-id="${historyId}"]`);
    if (form) {
        form.remove();
    }
    
    // تنظيف الملفات المؤقتة
    if (window.tempHistoryFiles) {
        delete window.tempHistoryFiles[historyId];
    }
}

// تحديث دالة renderHistoryItems لإظهار النموذج
function renderHistoryItems() {
    const container = document.getElementById('history-items-container');
    container.innerHTML = '';
    
    // عرض السجلات المحفوظة
    patientHistory.forEach(item => {
        const historyDiv = document.createElement('div');
        historyDiv.className = 'history-item';
        historyDiv.setAttribute('data-history-id', item.id);
        
        const imageCount = item.images ? item.images.length : 0;
        
        historyDiv.innerHTML = `
            <div class="history-header">
                <div class="history-date">${formatDate(item.date)}</div>
                <div>
                    <button type="button" class="btn btn-warning btn-sm" onclick="editHistoryItem(${item.id})" style="margin-left: 10px;">
                        <i class="fas fa-edit"></i> تعديل
                    </button>
                    <button type="button" class="btn btn-danger btn-sm" onclick="removeHistoryItem(${item.id})">
                        <i class="fas fa-trash"></i> حذف
                    </button>
                </div>
            </div>
            <div class="history-notes">
                ${item.notes}
            </div>
            ${imageCount > 0 ? `
                <div class="form-group">
                    <label>الصور المرفقة (${imageCount})</label>
                    <div class="history-images">
                        ${item.images.map((image, index) => `
                            <div class="history-image-container">
                                <img src="${image.data}" alt="${image.name}" onclick="viewMediaItem('${image.data}', 'image')">
                                <button type="button" class="history-image-remove" onclick="removeHistoryImage(${item.id}, ${index})">
                                    <i class="fas fa-times"></i>
                                </button>
                            </div>
                        `).join('')}
                    </div>
                </div>
            ` : ''}
        `;
        
        container.appendChild(historyDiv);
    });
    
    // إضافة زر الإضافة إذا لم يكن هناك نموذج مفتوح بالفعل
    const existingForm = container.querySelector('.history-form');
    if (!existingForm) {
        const addButtonContainer = document.createElement('div');
        addButtonContainer.className = 'history-add-btn-container';
        addButtonContainer.innerHTML = `
            <button type="button" id="add-history-btn" class="btn btn-primary">
                <i class="fas fa-plus"></i> إضافة تاريخ وملاحظة جديدة
            </button>
        `;
        container.appendChild(addButtonContainer);
        
        // إعادة ربط حدث النقر
        document.getElementById('add-history-btn').addEventListener('click', addNewHistoryItem);
    }
}

// دالة لتعديل سجل موجود
function editHistoryItem(historyId) {
    const historyItem = patientHistory.find(item => item.id === historyId);
    if (!historyItem) return;
    
    // إزالة السجل من العرض
    const historyDiv = document.querySelector(`[data-history-id="${historyId}"]`);
    if (historyDiv) {
        historyDiv.remove();
    }
    
    // إزالة من المصفوفة
    patientHistory = patientHistory.filter(item => item.id !== historyId);
    
    // إعادة إضافته كنموذج تعديل
    const historyFormHTML = `
        <div class="history-form" data-history-id="${historyId}">
            <h4 style="color: var(--primary-color); margin-bottom: 15px;">
                <i class="fas fa-edit"></i> تعديل السجل التاريخي
            </h4>
            
            <div class="form-row">
                <div class="form-group">
                    <label>التاريخ *</label>
                    <input type="date" id="history-date-${historyId}" class="form-control" value="${historyItem.date}">
                </div>
            </div>
            
            <div class="form-group">
                <label>ملاحظات *</label>
                <textarea id="history-notes-${historyId}" class="form-control" rows="3" required>${historyItem.notes}</textarea>
            </div>
            
            <div class="form-group">
                <label>صور إضافية (4 صور كحد أقصى)</label>
                <div class="history-images" id="history-images-preview-${historyId}">
                    ${historyItem.images ? historyItem.images.map((image, index) => `
                        <div class="history-image-container">
                            <img src="${image.data}" alt="${image.name}">
                            <button type="button" class="history-image-remove" onclick="removeSavedHistoryImage(${historyId}, ${index})">
                                <i class="fas fa-times"></i>
                            </button>
                        </div>
                    `).join('') : ''}
                </div>
                ${(!historyItem.images || historyItem.images.length < 4) ? `
                    <div style="margin-top: 15px;">
                        <label for="history-image-upload-${historyId}" class="upload-label" style="display: inline-block;">
                            <i class="fas fa-camera"></i> إضافة صور جديدة
                        </label>
                        <input type="file" id="history-image-upload-${historyId}" class="upload-input" accept="image/jpeg,image/jpg,image/png,image/webp" multiple onchange="previewHistoryImages(${historyId}, this.files)">
                        <small style="display: block; color: #777; margin-top: 5px;">يمكنك إضافة حتى ${4 - (historyItem.images ? historyItem.images.length : 0)} صور إضافية</small>
                    </div>
                ` : ''}
            </div>
            
            <div class="form-group" id="history-selected-files-${historyId}" style="display: none;">
                <label>الملفات الجديدة المحددة:</label>
                <div class="file-list" id="history-files-list-${historyId}">
                </div>
            </div>
            
            <div style="display: flex; gap: 15px; justify-content: center; margin-top: 20px;">
                <button type="button" class="btn btn-primary" onclick="saveHistoryItem(${historyId})">
                    <i class="fas fa-save"></i> حفظ التعديلات
                </button>
                <button type="button" class="btn btn-danger" onclick="cancelEditHistoryItem(${historyId}, ${JSON.stringify(historyItem)})">
                    <i class="fas fa-times"></i> إلغاء
                </button>
            </div>
        </div>
    `;
    
    const container = document.getElementById('history-items-container');
    container.insertAdjacentHTML('beforeend', historyFormHTML);
    
    // حفظ الصور الحالية مؤقتًا
    if (historyItem.images) {
        if (!window.tempHistoryFiles) {
            window.tempHistoryFiles = {};
        }
        // نحتاج لتحويل base64 إلى ملفات للعرض، لكن لأغراض التخزين نستخدم البيانات الحالية
        window.tempHistoryFiles[historyId] = [];
    }
}

// دالة لإلغاء التعديل
function cancelEditHistoryItem(historyId, originalItem) {
    // إزالة النموذج
    const form = document.querySelector(`[data-history-id="${historyId}"]`);
    if (form) {
        form.remove();
    }
    
    // إعادة إضافة السجل الأصلي
    patientHistory.push(JSON.parse(originalItem));
    renderHistoryItems();
    
    // تنظيف الملفات المؤقتة
    if (window.tempHistoryFiles) {
        delete window.tempHistoryFiles[historyId];
    }
}

// دالة لحذف صورة محفوظة
function removeSavedHistoryImage(historyId, imageIndex) {
    const historyItem = patientHistory.find(item => item.id === historyId);
    if (historyItem && historyItem.images) {
        historyItem.images.splice(imageIndex, 1);
        // تحديث العرض
        editHistoryItem(historyId);
    }
}

// تحديث دالة إزالة الصور
function removeHistoryImage(historyId, imageIndex) {
    if (confirm('هل أنت متأكد من حذف هذه الصورة؟')) {
        const historyItem = patientHistory.find(item => item.id === historyId);
        if (historyItem) {
            historyItem.images.splice(imageIndex, 1);
            renderHistoryItems();
            showNotification('تم حذف الصورة', 'info');
        }
    }
}

// تحديث دالة إزالة السجل
function removeHistoryItem(historyId) {
    if (confirm('هل أنت متأكد من حذف هذا السجل؟')) {
        patientHistory = patientHistory.filter(item => item.id !== historyId);
        renderHistoryItems();
        showNotification('تم حذف السجل', 'info');
    }
}
    </script>
</body>
</html>